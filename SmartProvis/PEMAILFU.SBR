 ' ***************************** Email Smtp Server Modul *****************************************************
 ' SMTP Server fÅr Superbase Routinen
 ' Firma : MIS Software
 ' Autor : Christian Wolff
 ' Modulname : MIS-SMTPServ
 ' This functions Copyright 2003 and later by Christian Wolff (service@mis-software.de)
 ' *********************************************************************************************************** 
 ' The Blat.dll is downloaded on http://www.blat.net/
 ' Thanks for sourceforge.net
 ' *********************************************************************************************************** 
 ' we have translated the functions in english spell
 ' History:
 ' ------------
 ' Version 1.32 faster send emails. Superbase not delete the bodyfile (old emailtxt.dat)
 '              Newfilename ist body.txt.    
 ' ***********************************************************************************************************
 CALL main()
 REM SUB main()
   REM REQUEST "Diese Datei ist eine Funktionsbibliothek","",139
   REM CALL examplemail()
   REM QUIT 
 REM END SUB 

SUB examplemail()
  e% = 1
  REQUEST "Wollen Sie wirklich " + STR$ (e%,"99.") + "  Email(s) versenden ?","",148,ant%%
  IF ant%% = 1 THEN 
      FOR i% = 1 TO e%
       CALL TTemail(RetVal%%,RetVal$)
      NEXT 
      REQUEST "Fertig Fehlercode : " + LTRIM$ ( STR$ (RetVal%%,"9999.")), LEFT$ (RetVal$,72)
  END IF 
 END SUB 

 ' ******************************************************************************************************
 ' Beispiel-Aufruf fÅr Emailversand.
 ' CALL TTemail(RetVal%%,RetVal$)
 ' RetVal%% = Fehlernummer, 0 bedeutet kein Fehler
 ' RetVal$  = Fehlertext
 ' English:
 ' ---------
 ' Example for sending emails.
 ' CALL TTemail(RetVal%%,RetVal$)
 ' RetVal%% = Errorcode, 0 No errors
 ' RetVal$  = errormessage
 ' ******************************************************************************************************
SUB TTemail(RetVal%%,RetVal$)
 X%% = MK_Init%%()
 X%% = MK_SendServer%%("post.strato.de","25","info@codie-software.de","codie8474#",SendServer$)
 X%% = MK_SendFrom%%("info@codie-software.de",SendFrom$)
 X%% = MK_SendReply%%("info@codie.com",SendReply$)
 X%% = MK_Priority%%(1,Priority$)
 X%% = MK_SendTo%%("ab@codie.com",SendTo$)
 X%% = MK_XHeader%%("CODie Power mailer",SendHeader$)
 REM X%% = MK_SendCC%%("technik@mis-software.de,service@mis-software.de",SendCC$)
 REM X%% = MK_SendBCC%%("ab@codie.com,send@codie.com",SendBCC$)
 X%% = MK_Subject%%("Test Email von CODie software products e.K.",SendSubject$)
 CALL MK_WriteBody0()' Text in Htmlformat . You must change the parameter to MK_Html%%(1,Html$)
 'CALL MK_WriteBody2()' Text NOT in Htmlformat . You must change the parameter to MK_Html%%(0,Html$)
 'X%% = MK_Attach%%( DIRECTORY + "\attach\email.pdf",AttachString$)
 'X%% = MK_Attach%%( DIRECTORY + "\attach\email_abc.pdf",AttachString$)
 X%% = MK_LogFile%%("logdatei.log",LogDateiName$)
 X%% = MK_Html%%(0,Html$)
 X%% = MK_SendGo%%(RetVal%%,RetVal$,SendHeader$,SendTo$,SendFrom$,SendReply$,Priority$,SendCC$,SendBCC$,SendSubject$,LogDateiName$,SendServer$,AttachString$,Html$)
 X%% = MK_InitReset%%()
 END SUB 

 ' ******************************************************************************************************
 ' Testtext als Email versenden als Body(Haupttext)
 ' MK_Body%% setzt den Text einer Zeile in einer Email
 ' X%% = MK_Body%%("Das ist ein Bodytext,",OutClose%%)
 ' OutClose%% = 0 , die Datei body.txt wird nicht geschlossen(kein CLOSE OUTPUT)
 ' OutClose%% = 1 , die Datei body.txt wird geschlossen(CLOSE OUTPUT)
 ' Hinweis :
 ' In der letzten Zeile ist eine 1 zwingend erforderlich
 ' English:
 ' ---------
 ' Testtext for sending emails via smtp (bodytext)
 ' MK_Body%% set the text for one line in the file body.txt
 ' X%% = MK_Body%%("this is a example,",OutClose%%)
 ' OutClose%% = 0 , the file body.txt are not closing(No CLOSE OUTPUT)
 ' OutClose%% = 1 , teh file body.txt are closing the textfile body.txt(CLOSE OUTPUT)
 ' Tipp :
 ' the last command must be Outclose%%=1
 ' ****************************************************************************************************** 
SUB MK_WriteBody0()
 X%% = MK_Body%%("Sehr geehrte Damen und Herren,",0)
 X%% = MK_Body%%("",0)
 X%% = MK_Body%%("Dies ist der erfolgreiche Test!",0)
 X%% = MK_Body%%("Ihr email scheint korrekt eingestellt zus sein",0)
 X%% = MK_Body%%("                 ",0)
 X%% = MK_Body%%("Mit freundlichen GrÅ·en",0)
 X%% = MK_Body%%("CODie software products e.K.",0)
 X%% = MK_Body%%("Datum :" + DATE$ ( TODAY ,"0d.mm.yyyy") + "  Zeit : " + TIME$ ( NOW ,"mm:hh:ss"),0)
 X%% = MK_Body%%("",1)
 END SUB 
 


SUB MK_WriteBody()
 X%% = MK_Body%%("Sehr geehrte Damen und Herren,<BR><BR>",0)
 X%% = MK_Body%%("",0)
 X%% = MK_Body%%("Dîss isn Tescht.<BR>",0)
 X%% = MK_Body%%("Wir bitten öberweisung bis zum <FONT>" + DATE$ ( TODAY + 10,"0d.mm.yyyy") + ".</FONT><BR><BR>",0)
 X%% = MK_Body%%("mfg<BR>",0)
 X%% = MK_Body%%("Andreas Bargfried<BR>",0)
 X%% = MK_Body%%("CODie software products e.K.<BR><BR>",0)
 X%% = MK_Body%%("Datum :" + DATE$ ( TODAY ,"0d.mm.yyyy") + "  Zeit : " + TIME$ ( NOW ,"mm:hh:ss") + "<BR>",0)
 X%% = MK_Body%%("-------------------------------------",1)
 END SUB 

 ' Text NOT in HtmlFormat.
SUB MK_WriteBodyN(ttext$)
 X%% = MK_Body%%(ttext$,1)
 REM X%% = MK_Body%%(bodytxt$,"",1)
 END SUB 
 
 ' ***********************  Funktionen fÅr SMTP-Server  *************************************************
 ' English:
 ' ---------
 ' Functions for SMTP-Sending Emails
 ' ******************************************************************************************************
 ' ******************************************************************************************************
 ' ******************************************************************************************************
 ' ******************************************************************************************************
 ' Versenden der Email 
 ' English:
 ' ---------
 ' Sending emails for SMTP
 ' This is the startcommand for sending a email
 ' X%% = MK_SendGo%%()
 ' ******************************************************************************************************
FUNCTION MK_SendGo%%(RetVal%%,RetVal$,SendHeader$,SendTo$,SendFrom$,SendReply$,Priority$,SendCC$,SendBCC$,SendSubject$,LogDateiName$,SendServer$,AttachString$,Html$)
    IF LogDateiName$ = "" THEN LogDateiName$ = " ":END IF 
    tdatei$ = Gbodytxt$
    DIRECTORY _netpath$
    SendString$ = tdatei$ + SendHeader$ + SendTo$ + SendFrom$ + SendReply$ + Priority$ + SendCC$ + SendBCC$ + SendSubject$ + LogDateiName$ + SendServer$ + AttachString$ + Html$
    REM SendString$ = "body.txt" + SendHeader$ + SendTo$ + SendFrom$ + SendReply$ + Priority$ + SendCC$ + SendBCC$ + SendSubject$ + LogDateiName$ + SendServer$ + AttachString$ + Html$

    sendstring1$ = sendstring$
    REM CALL Fehler(SendString1$,"")
    RetVal%% = CALL ("Send",SendString1$)
    SELECT CASE RetVal%%
     CASE 0
       RetVal$ = "Emailversand OK"
     CASE 1
       RetVal$ = "SMTP-Fehler beim verbinden,  SMTP-Adresse oder Port oder Username oder das Passwort sind falsch (bitte bei Mitarbeitereinstellungen prÅfen)!"
     CASE 2
       RetVal$ = "Textdatei fÅr Emailbody:" + Gbodytxt$ + " ist nicht vorhanden oder der Username oder das Passwort sind falsch (bitte bei Mitarbeitereinstellungen prÅfen)!"
     CASE 3
       RetVal$ = "Datei-Lesefehler"
     CASE 4
       RetVal$ = "Falscher Dateityp"
     CASE 5
       RetVal$ = "Fehler beim Lesen des Messagetextes"
     CASE 12
       RetVal$ = "Server nicht gefunden oder Absendeadresse falsch"
     CASE 13
       RetVal$ = "Fehler beim Lesen aus dem TEMP-Verzeichnis"
    END CASE 
 END FUNCTION 
 ' ****************************************************************************************************** 
 ' Initialisierung und Registrierung der BLAT.DLL
 ' English:
 ' ---------
 ' Register the DLL
 ' X%% = MK_Init%%()
 ' ******************************************************************************************************
FUNCTION MK_Init%%()
     SET ERROR OFF 167
     SET ERROR OFF 168
     REGISTER CLEAR "Send"
     REGISTER _netpath$ + "blat.dll","Send","IC"
 END FUNCTION 
 ' ******************************************************************************************************
 ' Entfernen der registrierten Funktion "Send"
 ' English:
 ' ---------
 ' Remove the DLL from Windows Register
 ' X%% = MK_InitReset%%()
 ' ******************************************************************************************************
FUNCTION MK_InitReset%%()
     REGISTER CLEAR "Send"
     SET ERROR ON 167
     SET ERROR ON 168
 END FUNCTION 
 ' ******************************************************************************************************
 ' Schreiben des X-Headers
 ' X%% = MK_XHeader%%(Header$,SendHeader$)
 ' Header$ = "MIS Software"
 ' RÅckgabewert wird an SendHeader$ Åbergeben
 ' English:
 ' ---------
 ' Write X-Headers
 ' X%% = MK_XHeader%%(Header$,SendHeader$)
 ' Header$ = "MIS Software"
 ' Returnvalue on SendHeader$
 ' ******************************************************************************************************
FUNCTION MK_XHeader%%(Header$,SendHeader$)
  SendHeader$ = " -x " + CHR$ (34) + "X-Header: " + Header$ + CHR$ (34) + " "
 END FUNCTION 
 ' ******************************************************************************************************
 ' Subject (Betreffzeile) wird erstellt
 ' X%% = MK_Subject%%(subject$,SendSubject$)
 ' subject$ = "Das ist eine Testmail von MIS Software"
 ' RÅckgabewert wird an SendSubject$ Åbergeben
 ' English:
 ' ---------
 ' Makes Subjectline
 ' X%% = MK_Subject%%(subject$,SendSubject$)
 ' subject$ = "Thois is a example mail from MIS Software"
 ' Returnvalue on SendHeader$
 ' ******************************************************************************************************
FUNCTION MK_Subject%%(subject$,SendSubject$)
  SendSubject$ = " -s " + CHR$ (34) + subject$ + CHR$ (34)
 END FUNCTION 
 ' ******************************************************************************************************
 ' Schreiben einer Textzeile im Haupttext (Body)
 ' X%% = MK_Body%%(BodyText$,OutClose%%)
 ' BodyText$ = "Das ist die erste Zeile in der Email"
 ' OutClose%% = 0/1, Bei 0 wird kein CLOSE OUTPUT geschrieben, bei 1 wird CLOSE OUTPUT geschrieben
 ' English:
 ' ---------
 ' Write a textline in bodytext
 ' X%% = MK_Body%%(BodyText$,OutClose%%)
 ' BodyText$ = "tihis is a example line in this email"
 ' OutClose%% = 0/1, 0 write no CLOSE OUTPUT in body.txt, 1 Write CLOSE OUTPUT in body.txt
 ' ******************************************************************************************************
FUNCTION MK_Body%%(datatxt$,OutClose%%)
   OPEN Gbodytxt$ FOR APPEND 
     ? FN ANSI(datatxt$)
     IF OutClose%% = 1 THEN 
      CLOSE OUTPUT 
     END IF 
   END FUNCTION 
 ' ******************************************************************************************************
 ' Schreiben der Absendeadresse
 ' X%% = MK_SendFrom%%(_SendFrom$,SendFrom$)
 ' _SendFrom$ = "service@mis-software.de"
 ' RÅckgabewert wird an SendFrom$ Åbergeben
 ' English:
 ' ---------
 ' Write Fromadress
 ' X%% = MK_SendFrom%%(_SendFrom$,SendFrom$)
 ' _SendFrom$ = "service@mis-software.de"
 ' Returnvalue on SendFrom$
 ' ******************************************************************************************************
FUNCTION MK_SendFrom%%(_SendFrom$,SendFrom$)
  SendFrom$ = " -f " + _SendFrom$ + " "
 END FUNCTION 
 ' ******************************************************************************************************
 ' Schreiben der Absendeadresse
 ' X%% = MK_SendReply%%(_SendReply$,SendReply$)
 ' _SendReply$ = "support@mis-software.de"
 ' RÅckgabewert wird an SendReply$ Åbergeben
 ' English:
 ' ---------
 ' Write Replyadress
 ' X%% = MK_SendReply%%(_SendReply$,SendReply$)
 ' _SendReply$ = "support@mis-software.de"
 ' Returnvalue on SendReply$
 ' ******************************************************************************************************
FUNCTION MK_SendReply%%(_SendReply$,SendReply$)
  SendReply$ = " -replyto " + _SendReply$ + " "
 END FUNCTION 
 ' ******************************************************************************************************
 ' Erzeugen der PrioritÑt der Email (z.B. rotes Ausrufezeichen)
 ' X%% = MK_Priority%%(Priority%%,Priority$)
 ' Priority%% = 0/1, Bei 1 hohe PrioritÑt
 ' RÅckgabewert wird an Priority$ Åbergeben
 ' English:
 ' ---------
 ' Write Priority for this email
 ' X%% = MK_Priority%%(Priority%%,Priority$)
 ' Priority%% = 0/1/2, 1 high Priority, 0 Low Priority,, 2 Normal Priority
 ' Returnvalue on Priority$ 
 ' ******************************************************************************************************
FUNCTION MK_Priority%%(Priority%%,Priority$)
   Priority$ = " -priority " + STR$ (Priority%%,"0.") + " "
 END FUNCTION 
 ' ******************************************************************************************************
 ' Schreiben der EmpfÑngeradresse
 ' X%% = MK_SendTo%%(_SendTo$,SendTo$)
 ' _SendTo$ = "technik@mis-software.de"
 ' RÅckgabewert wird an SendTo$ Åbergeben
 ' English:
 ' ---------
 ' Write ToAdress
 ' X%% = MK_SendTo%%(_SendTo$,SendTo$)
 ' _SendTo$ = "technik@mis-software.de"
 ' Returnvalue on SendTo$ 
 ' ******************************************************************************************************
FUNCTION MK_SendTo%%(_SendTo$,SendTo$)
  SendTo$ = " -t " + _SendTo$ + " "
 END FUNCTION 
 ' ******************************************************************************************************
 ' Schreiben der CC-Emailadresse(n)
 ' X%% = MK_SendCC%%(_SendCC$,SendCC$)
 ' _SendCC$ = "maier@deutschland.de,krause@aol.com"
 ' Die Emailadressen werden durch ein , (Komma) getrennt!
 ' RÅckgabewert wird an SendCC$ Åbergeben
 ' English:
 ' ---------
 ' Write CCAdress
 ' X%% = MK_SendCC%%(_SendCC$,SendCC$)
 ' _SendCC$ = "maier@deutschland.de,krause@aol.com"
 ' cut the emailadresses with ","!
 ' Returnvalue on SendCC$ 
 ' ******************************************************************************************************
FUNCTION MK_SendCC%%(_SendCC$,SendCC$)
  SendCC$ = " -c " + _SendCC$ + " "
 END FUNCTION 
 ' ******************************************************************************************************
 ' Schreiben der BCC-Emailadresse(n)
 ' X%% = MK_SendBCC%%(_SendBCC$,SendBCC$)
 ' _SendBCC$ = "maier@deutschland.de,krause@aol.com"
 ' Die Emailadressen werden durch ein , (Komma) getrennt!
 ' RÅckgabewert wird an SendBCC$ Åbergeben
 ' English:
 ' ---------
 ' Write BCCAdress
 ' X%% = MK_SendBCC%%(_SendBCC$,SendBCC$)
 ' _SendBCC$ = "maier@deutschland.de,krause@aol.com"
 ' cut the emailadresses with ","!  
 ' Returnvalue on SendBCC$  
 ' ******************************************************************************************************
FUNCTION MK_SendBCC%%(_SendBCC$,SendBCC$)
  SendBCC$ = " -bcc " + _SendBCC$ + " "
 END FUNCTION 
 ' ******************************************************************************************************
 ' Datei der Email anhÑngen
 ' X%% = MK_Attach%%(attach$,AttachString$)
 ' attach$ = "C:\test\testmail.txt"
 ' attach$ = "C:\test\testmail.exe"
 ' RÅckgabewert wird an AttachString$ Åbergeben
 ' English:
 ' ---------
 ' File to attach on actual email
 ' X%% = MK_Attach%%(attach$,AttachString$)
 ' attach$ = "C:\test\testmail.txt"
 ' attach$ = "C:\test\testmail.exe"
 ' Returnvalue on AttachString$
 ' ******************************************************************************************************
FUNCTION MK_Attach%%(attach$,AttachString$)
  AttachString$ = AttachString$ + " -attach " + attach$
 END FUNCTION 
 ' ******************************************************************************************************
 '
 ' X%% = MK_SendServer%%(MailServer$,SmtpPort$,SendUser$,SendPassword$,SendServer$)
 ' MailServer$      = SMTP-Mailserver, z.B. "post.strato.de"
 ' SmtpPort$        = Port fÅr SMTP-Server, z.B. "25"
 ' SendUser$        = Username fÅr SMTP, falls ESMTP benutzt wird, d.h., bei jedem versenden einer Email
 '                    muss der Client sich anmelden. Sollte kein ESMTP erforderlich sein, dann
 '                    SendUser$ =""
 ' SendPassword$    = Password fÅr ESMTP. Sollte kein ESMTP erforderlich sein, dann
 '                    SendPassword$ =""
 '
 ' RÅckgabewert wird an SendServer$ Åbergeben
 ' Beispiel :
 ' -----------
 ' X%% = MK_SendServer%%("post.strato.de","25","Usermaier","PWabc",SendServer$)
 ' English:
 ' ---------
 ' X%% = MK_SendServer%%(MailServer$,SmtpPort$,SendUser$,SendPassword$,SendServer$)
 ' MailServer$      = SMTP-Mailserver, e.g. "post.strato.de"
 ' SmtpPort$        = Port for SMTP-Server, e.g. "25"
 ' SendUser$        = Username for SMTP, if use ESMTP. 
 '                    If use no ESMTP then value SendUser$ =""
 ' SendPassword$    = Password for ESMTP. If no use ESMTP then SendPassword$ =""
 ' Returnvalue on SendServer$
 ' Example :
 ' -----------
 ' X%% = MK_SendServer%%("post.strato.de","25","Usermaier","PWabc",SendServer$)
 ' ******************************************************************************************************
FUNCTION MK_SendServer%%(MailServer$,SmtpPort$,SendUser$,SendPassword$,SendServer$)
  OPEN Gbodytxt$ FOR OUTPUT 
  CLOSE OUTPUT 
  IF SendUser$ <> "" THEN 
    SendServer$ = "-server " + MailServer$ + " -port " + SmtpPort$ + " -u " + SendUser$ + " -pw " + SendPassword$
   ELSE 
    SendServer$ = "-server " + MailServer$ + " -port " + SmtpPort$
  END IF 
 END FUNCTION 

 ' ******************************************************************************************************
 ' AuswÑhlen, ob eine Email im HTML oder Textformat erstellt werden soll 
 ' X%% = MK_Html%%(html%%,Html$) 
 ' html%% = 0 , dann Textformat
 '          1 , dann Htmlformat
 ' X%% = MK_Html%%(html%%,Html$) 
 ' Html$  = RÅckgabewert
 '
 ' English:
 ' ---------
 ' X%% = MK_Html%%(html%%,Html$) 
 ' html%% = 0 , Textformat
 '          1 , Htmlformat
 ' X%% = MK_Html%%(html%%,Html$) 
 ' Html$  = Returnvalue
 ' ****************************************************************************************************** 
FUNCTION MK_Html%%(html%%,Html$)
  IF html%% = 0 THEN 
    Html$ = ""
   ELSE 
    Html$ = " -html"
  END IF 
 END FUNCTION 
 
 ' ******************************************************************************************************
 ' Erstellen eines Eintrages in die Logdatei
 ' X%% = MK_LogFile%%(Datei$,LogDateiName$)
 ' Datei$ = Dateiname fÅr Logdatei
 ' X%% = MK_LogFile%%("logdatei.log",LogDateiName$)
 ' 
 ' RÅckgabewert wird an LogDateiName$ Åbergeben
 ' English:
 ' ---------
 ' If you want use a logfile, then Datei$ is the logfilename, e.g. "testlog.txt"
 ' X%% = MK_LogFile%%(Datei$,LogDateiName$)
 ' Datei$ = Filename for Logfile
 ' X%% = MK_LogFile%%("logdatei.log",LogDateiName$)
 ' Returnvalue on LogDateiName$
 ' ******************************************************************************************************
FUNCTION MK_LogFile%%(Datei$,LogDateiName$)
   LogDateiName$ = " -log " + Datei$ + " "
 END FUNCTION 



 REM Erzeugung Sendebericht

SUB SendeBer(Ppassw$,adresse$,TOM$,attachges$,ccx$,bccx$,Betreff$,emailtext$)

   REM CALL WriteINIDes("EMAILSERVER","HOST",EMAILShost.supervis,datei$)
   REM CALL WriteINIDes("EMAILSERVER","PORT",port$,datei$)
   REM CALL WriteINIDes("EMAILSERVER","USERID",UserID$,datei$)
   REM CALL WriteINIDes("EMAILSERVER","PW",Ppassw$,datei$)
   REM CALL WriteINIDes("EMAILSERVER","ABSFirma",AFirma$,datei$)
   REM CALL WriteINIDes("EMAILSERVER","ABSName",AName$,datei$)
   REM CALL WriteINIDes("EMAILSERVER","ABSEMAIL",ANummer$,datei$)
   REM CALL WriteINIDes("EMAILSERVER","KOPIEANABSENDER",Sen$,datei$)
   REM CALL WriteINIDes("EMAILSERVER","BerSendenummer",BerSend$,datei$)
   REM CALL WriteINIDes("EMAILSERVER","BerSendenummer1",BerSend1$,datei$)
   REM CALL WriteINIDes("EMAILSERVER","TO",TOM$,datei$)
   REM CALL WriteINIDes("EMAILSERVER","SENDEBERICHT",senber$,datei$)
   REM CALL WriteINIDes("EMAILSERVER","Betreff",Betreff$,datei$)
 



     datei$ = GMACodeDir$ + "codietes.ini"
     Host$ = ReadINIDes$("EMAILSERVER","HOST",datei$)
     Port$ = ReadINIDes$("EMAILSERVER","PORT",datei$)
     UserID$ = ReadINIDes$("EMAILSERVER","USERID",datei$)
     Betreff$ = ReadINIDes$("EMAILSERVER","Betreff",datei$)
     AFirma$ = ReadINIDes$("EMAILSERVER","ABSFirma",datei$)
     AName$ = ReadINIDes$("EMAILSERVER","ABSName",datei$)
     ANummer$ = ReadINIDes$("EMAILSERVER","ABSEMAIL",datei$)
     Bersend$ = ReadINIDes$("EMAILSERVER","BerSendenummer",datei$)
     Bersend1$ = ReadINIDes$("EMAILSERVER","BerSendenummer1",datei$)

     sendtxt$ = _netpath$ + STR$ (GMACodema%,"000000") + "-1.txt"
     IF EXISTS (sendtxt$) THEN DELETE sendtxt$
     Gbodytxt$ = _netpath$ + STR$ (GMACodema%,"000000") + ".txt"
     IF EXISTS (Gbodytxt$) THEN 
       COPY Gbodytxt$ TO sendtxt$
       DELETE Gbodytxt$
     END IF 

     X%% = MK_Init%%()
     X%% = MK_SendServer%%(Host$,port$,UserID$,Ppassw$,SendServer$)
     REM Absender
     von1$ = "an " + adresse$ + " von " + AName$
     X%% = MK_SendFrom%%(ANUmmer$,SendFrom$)
     REM antworten an
     X%% = MK_SendReply%%(ANUmmer$,SendReply$)
     REM 0=klein,1=gro·
     X%% = MK_Priority%%(0,Priority$)
     X%% = MK_SendTo%%(BerSend$,SendTo$)
     X%% = MK_XHeader%%("xxPower mailer",SendHeader$)
     IF BerSend1$ <> "" THEN 
       X%% = MK_SendBCC%%(BerSend1$,SendBCC$)
     END IF 
     subject1$ = "Sendebericht: " + adresse$ + "-" + TOM$
     X%% = MK_Subject%%(subject1$,SendSubject$)
     REM CALL Fehler("Sendebericht","")
     CALL MK_WriteBodyN("Absenderfirma: " + AFirma$)
     CALL MK_WriteBodyN("Absendername: " + AName$)
     CALL MK_WriteBodyN("Absenderemail: " + ANummer$)
     CALL MK_WriteBodyN("email an: " + TOM$)
     CALL MK_WriteBodyN("Betreff: " + Betreff$)
     CALL MK_WriteBodyN("CC: " + ccx$)
     CALL MK_WriteBodyN("BCC: " + bccx$)
     CALL MK_WriteBodyN("DateianhÑnge: ")
     IF attachges$ <> "" THEN CALL MK_WriteBodyN(attachges$)
     CALL MK_WriteBodyN("")
     REM CALL Fehler(zeile$,emailtext$)
     CALL MK_WriteBodyN(emailtext$)
     GOTO wei060920051
     OPEN sendtxt$ FOR INPUT 
     WHILE NOT EOF ("*")
       INPUT LINE zeile$
       CALL Fehler(zeile$,"")
       zeile1$ = FN ansi(zeile$)
       zeile2$ = FN oem(zeile$)
       zeile3$ = FN ibm(zeile$)
       CALL MK_WriteBodyN(zeile$)
     WEND 
wei060920051: 
     X%% = MK_LogFile%%(GMACodeDir$ + "emailsend.log",LogDateiName$)
     X%% = MK_Html%%(0,Html$)
     MOUSE OFF 
     X%% = MK_SendGo%%(RetVal%%,RetVal$,SendHeader$,SendTo$,SendFrom$,SendReply$,Priority$,SendCC$,SendBCC$,SendSubject$,LogDateiName$,SendServer$,AttachString$,Html$)
     MOUSE ON 
     X%% = MK_InitReset%%()
 
 END SUB 



 


 
SUB TerLiMail(codeaq%)
 CALL DFile(2,"OFFICE\tvorlage" + _fpw$)
 CALL DFile(2,"OFFICE\" + GADRDat$ + _fpw$)
 CALL DFile(2,"OFFICE\" + GTelDat$ + _fpw$)
 CALL DFile(2,"OFFICE\aktionen" + _fpw$)
 req% = 1
 _cuaq% = codeaq%
 SELECT FIRST FILE GAkquiDat$ INDEX codeaq.GAkquiDat$
 SELECT KEY codeaq% FILE GAkquiDat$ INDEX codeaq.GAkquiDat$
 SELECT FIRST FILE "supervis" INDEX codema.supervis
 SELECT KEY codema.GAkquiDat$ FILE "supervis" INDEX codema.supervis
 SELECT FIRST FILE GAdrDat$ INDEX codeku.GAdrDat$
 SELECT KEY codeku.GAkquiDat$ FILE GAdrDat$ INDEX codeku.GAdrDat$
 SELECT FIRST FILE GTelDat$ INDEX codeku.GTelDat$
 SELECT KEY codeku.GAkquiDat$ FILE GTelDat$ INDEX codeku.GTelDat$
 SELECT FORM KEY codeaq% FILE GAkquiDat$ INDEX codeaq.GAkquiDat$
 knr% = CodeKU.GAdrDat$
 FORM 
 IF req% = 1 THEN 
     lastT1% = _cuaq%
     _continue% = 1
     IF _continue% <> 0 THEN 
       cudat$ = DATE$ ( TODAY ,"0d.mm.yyyy")
       datanz$ = DATE$ ( TODAY ,"0d.mm.yyyy")
       SET STATUS "Bereit"
       _formend% = 0
       WHILE _formend% = 0
         REM vbezug$ = "Adre&sse"
         REM _vcodema% = vcodema%
         AQsub% = 0
         akmaske$ = "AKQMAIL"
         ta% = 1
         IF GCODie% = - 1 THEN 
           IF GCODieRuf1% < 0 THEN 
             ta% = 0
           ELSE 
             ta% = 1
           END IF 
         END IF 
         IF UCASE$ ( FORM ) <> akmaske$ OR ta% = 1 THEN 
           SET HEADING title$ + " - Termine"
           IF EXISTS (GOFFForm$ + akmaske$ + ".sbv") THEN 
             OPEN FORM GOFFForm$ + akmaske$
           ELSE 
             OPEN FORM GOFFForm$ + akmaske$
           END IF 
           SET f = Superbase.Form
           SELECT FORM KEY _cuaq% INDEX codeaq.GAkquiDat$
           SET STATUS "Termine"
           CALL MNAKQUISE()
           MENU 5,4,0,"&Adresshistorie,F10","AQAdrHistT","Adresshistorie anzeigen/drucken"
           MENU ON 
           REM CALL Fehler("","")
           CALL AKQUISEIntro1()
           SELECT FORM KEY _cuaq% INDEX codeaq.GAkquiDat$
           REM FORM 
           SET DISPLAY ON 
           FORM 3
         END IF 
         CALL AQButtUpdate()
         SET STATUS "Bereit"
         IF NOT NEW (GAkquiDat$) THEN 
           MENU ON 
           MOUSE ON 
           IF akmaske$ <> "AKQMAIL" THEN 
             f.suchen.enabled = - 1
             f.suchen.visible = - 1
             f.abbruch.enabled = 0
             f.abbruch.visible = 0
             f.abbruch2.enabled = 0
             f.abbruch2.visible = 0
             IF _projeKt$ LIKE "PROVIS" AND workstation% = 0 THEN 
               f.vertrag.enabled = - 1
               f.vertrag.visible = - 1
             ELSE 
               f.vertrag.enabled = 0
               f.vertrag.visible = 0
             END IF 
           END IF 
           
           WAIT MOUSE OR KEY OR UPDATE OR MENU 
           GET k$
           SELECT CASE ASC (k$)
           CASE CrsLeft%,PgUp%
             CALL AQPrev()
           CASE CrsRight%,PgDn%
             CALL AQNext()
           END SELECT 
           IF k$ = CHR$ (27) THEN 
             IF PAGE > 1 THEN 
               FORM 1
             ELSE 
               _formend% = 1
             END IF 
           END IF 
         ELSE 
           AQsub% = 99
         END IF 
         SELECT CASE AQsub%
         CASE 102
           REM in der Emailmaske von Akquise EMAIL versenden aufrufen
           _cuaq% = CodeAQ.AKQUISE
           CALL EMAILManSend(CodeAQ.AKQUISE,1)
         CASE 101
           REM TerminÅbersicht Kunde 12082003
           codeku% = codeku.akquise
           codeaq% = codeaq.Akquise
           _cuaq% = codeaq%
           CALL KunTer1()
           knr% = codeku%
           GCodieruf2% = 0
           MOUSE OFF 
           SELECT FIRST FILE "ADRESSEN" INDEX codeku.adressen
           SELECT KEY codeku% FILE "ADRESSEN" INDEX codeku.adressen
           IF UCASE$ ( FORM ) <> akmaske$ THEN 
             SET HEADING title$ + " - Termine"
             OPEN FORM GOFFForm$ + akmaske$
             SET f = Superbase.Form
             SET STATUS "Termine"
             CALL MNAKQUISE()
             MENU 6,3,1,"Liste erneut &anzeigen,F7","AQTermineO2","Suchliste erneut anzeigen"
             MENU ON 
             FORM 
             SET DISPLAY ON 
           END IF 
           MOUSE OFF 
           SELECT FIRST FILE "AKQUISE" INDEX codeaq.akquise
           SELECT FORM KEY codeaq% FILE "AKQUISE" INDEX codeaq.akquise
           FORM 
           CALL AKQUISEIntro1()
           MOUSE ON 
         CASE 100
           REM VertragsÅbersicht
           CALL DFile(3,"gekond" + _fpw$)
           CALL DFile(3,"kvertrag" + _fpw$)
           CALL DFile(3,"maadr" + _fpw$)
           CALL DFile(3,"sparten" + _fpw$)
           CALL DFile(3,"vorgang" + _fpw$)
           SELECT KEY codeku.GAkquiDat$ FILE GAdrDat$ INDEX codeku.GAdrDat$
           SELECT KEY codeku.GAkquiDat$ FILE "kvertrag" INDEX codeku.kvertrag
           CALL KVERTRAGGR()
 
         CASE 99
           IF ergdatuma$ = "TRUE" AND NOT ( NEW (GAkquiDat$) OR MOD (GAkquiDat$)) THEN 
             codeaq% = CodeAQ.GAkquiDat$
             
             SELECT KEY codeaq% LOCK FILE GAkquiDat$ INDEX CodeAq.GAkquiDat$
             IF ergebnis.GAkquiDat$ <> "" THEN 
               ergebnis.GAkquiDat$ = ergebnis.GAkquiDat$ + CHR$ (13) + CHR$ (10) + DATE$ ( TODAY ) + " " + TIME$ ( NOW ,"hh.mm")
             ELSE 
               ergebnis.GAkquiDat$ = ergebnis.GAkquiDat$ + DATE$ ( TODAY ) + " " + TIME$ ( NOW ,"hh.mm")
             END IF 
             CALL QuickStore(GAkquiDat$)
           END IF 
           MOUSE ON 
           IF akmaske$ = "AKQMAIL" THEN 
             ENTER EMAILTO.akquise,0
             GOTO re060920052
           END IF 
           IF PAGE = 1 THEN 
             CALL ButDesabled()
             f.seite2.enabled = 0
             f.offenetermine.enabled = 0
             f.terminplan.enabled = 0
             f.sprache.enabled = 0
             f.brief.enabled = 0
             f.Telefon.enabled = 0
             f.mitarbeiter.enabled = 0
             f.bezug.enabled = 0
             f.aktion.enabled = 0
             f.kundeninfo.enabled = 0
             f.Monat.enabled = 0
             f.Juli.enabled = 0
             f.Jahr.enabled = 0
             f.W1.enabled = 0
             f.W2.enabled = 0
             f.W3.enabled = 0
             f.W4.enabled = 0
             f.W5.enabled = 0
             f.W6.enabled = 0
             f.vertrag.enabled = 0
             f.vertrag.visible = 0
           END IF 
           IF PAGE = 2 THEN 
             f.bearb2.enabled = 0
             f.abbruch2.enabled = - 1
             f.abbruch2.visible = - 1
             f.kundeninfo2.enabled = 0
             f.seite1.enabled = 0
           END IF 
           IF PAGE < 3 THEN 
             MENU OFF 
             ENTER datum.GAkquiDat$,0
             MENU ON 
           END IF 
             IF PAGE = 1 THEN 
               CALL ButEnabled()
               f.seite2.enabled = - 1
               f.offenetermine.enabled = - 1
               f.terminplan.enabled = - 1
               f.sprache.enabled = - 1
               f.brief.enabled = - 1
               f.Telefon.enabled = - 1
               f.mitarbeiter.enabled = - 1
               f.bezug.enabled = - 1
               f.aktion.enabled = - 1
               f.kundeninfo.enabled = - 1
               f.Monat.enabled = - 1
               f.Juli.enabled = - 1
               f.Jahr.enabled = - 1
               f.W1.enabled = - 1
               f.W2.enabled = - 1
               f.W3.enabled = - 1
               f.W4.enabled = - 1
               f.W5.enabled = - 1
               f.W6.enabled = - 1
               f.suchen.enabled = - 1
               f.suchen.visible = - 1
               IF _projeKt$ LIKE "PROVIS" THEN 
                 f.vertrag.enabled = - 1
                 f.vertrag.visible = - 1
               ELSE 
                 f.vertrag.enabled = 0
                 f.vertrag.visible = 0
               END IF 
             END IF 
           END IF 
           IF PAGE = 2 THEN 
             f.bearb2.enabled = - 1
             f.abbruch2.enabled = 0
             f.abbruch2.visible = 0
             f.kundeninfo2.enabled = - 1
             f.seite1.enabled = - 1
           END IF 
           IF PAGE = 3 THEN 
             GEMAILRAUS$ = EMAILRAUS.akquise
             ENTER emailto.GAkquiDat$,0
           END IF 
re060920052: 
         END SELECT 
       WEND 
       IF art% = 2 THEN 
         SELECT FORM KEY _cuaq% INDEX codeaq.GAkquiDat$
         REM cuaq% = _cuaq%
       END IF 
     END IF 
     _formend% = 0
     IF akmaske$ = "AKQMAIL" THEN art% = 1
     IF art% = 1 THEN 
       cuaq% = 0
      _formend% = 0
     END IF 
     REM _formend% = 1
     IF NEW (GAkquiDat$) OR MOD (GAkquiDat$) AND CodeAQ.GAkquiDat$ <> 0 THEN CALL FStore(GAkquiDat$)
   END IF 
 
 END SUB 
  
 
 
 REM EMAIL aus Adresse versenden
SUB SendEMAIL(Nummer$,codeku%)
   FILE "supervis"
   INDEX codema.supervis
   SELECT FIRST FILE "supervis"
   SELECT KEY GMACodeMA% FILE "Supervis" INDEX codema.supervis
   SELECT FIRST FILE GAdrDat$ INDEX codeku.GAdrDat$
   SELECT KEY codeku% FILE GAdrDat$ INDEX codeku.GAdrDat$
 
   CALL AQRegAdr(codeku.GAdrDat$,Nummer$,0)
   CALL TerLiMail(cuaq%)
 
 
   REM CALL Fehler("Eigener Dialog oder eigene Form","")
 
   GMailBetreff$ = ""
   GMailIn% = 0
 END SUB 

 REM Zugangsdaten - EMAIL aus Adresse versenden
SUB SendEMAIL1(Nummer$,codeku%)
   FILE "supervis"
   INDEX codema.supervis
   SELECT FIRST FILE "supervis"
   SELECT KEY GMACodeMA% FILE "Supervis" INDEX codema.supervis
   SELECT FIRST FILE GAdrDat$ INDEX codeku.GAdrDat$
   SELECT KEY codeku% FILE GAdrDat$ INDEX codeku.GAdrDat$
 
   CALL AQRegAdr(codeku.GAdrDat$,Nummer$,1)
   CALL TerLiMail(cuaq%)
 
 
   REM CALL Fehler("Eigener Dialog oder eigene Form","")
 
   GMailBetreff$ = ""
   GMailIn% = 0
 END SUB 
   

 REM Werbe - EMAIL aus Adresse versenden
SUB SendEMAIL2(Nummer$,codeku%)
   CALL DFile(2,"OFFICE\wemail" + _fpw$)
   FILE "supervis"
   INDEX codema.supervis
   SELECT FIRST FILE "supervis"
   SELECT KEY GMACodeMA% FILE "Supervis" INDEX codema.supervis
   SELECT FIRST FILE GAdrDat$ INDEX codeku.GAdrDat$
   SELECT KEY codeku% FILE GAdrDat$ INDEX codeku.GAdrDat$
   GWemailAbr% = 0
   CALL AQRegAdr(codeku.GAdrDat$,Nummer$,2)
   IF GWemailAbr% = - 1 THEN 
     CALL TerLiMail(cuaq%)
   END IF 
 
 
   REM CALL Fehler("Eigener Dialog oder eigene Form","")
 
   GMailBetreff$ = ""
   GMailIn% = 0
 END SUB 

SUB EMAILATT(nr%)
 codeaq% = codeaq.GAkquiDat$
 codeku% = codeku.GAkquiDat$
 iniPath$ = ""
 iniPath$ = DokuGetNam$(codeku%)
 IF iniPath$ <> "" THEN a% = - 1
 IF MOD ("akquise") THEN STORE FILE "akquise"
 req% = 0
     DIRECTORY cdir$
     IF a% = - 1 THEN 
       REQUEST "Erstelle Arbeitskopie der zu versendenden Datei","",2
       SET STATUS "Erstelle Arbeitskopie der zu versendenden Datei"
       MOUSE OFF 
       endung$ = GetDateiendung$(iniPath$)
       REM zz$ = GMACodeDir$ + STR$ (codeaq%,"000000") + "-" + STR$ (nr%,"0") + "." + endung$
       zz$ = _netpath$ + "EMAILATT\" + STR$ (codeaq%,"000000") + "-" + STR$ (nr%,"0") + "." + endung$
       REM IF EXISTS (zz$) THEN DELETE zz$
       a% = CALL ("_SBFileExists",zz$)
       IF a% = - 1 THEN 
         a% = CALL ("_SBFileDelete1",zz$)
       END IF 
       a% = CALL ("_SBFileCopy",iniPath$,zz$)
       textvorlage$ = FN ansi(iniPath$)
       IF a% <> - 1 THEN 
         textvorlage$ = ""
         zz$ = ""
       END IF 
       req% = 1
       MOUSE ON 
       SET STATUS ""
     END IF 
 
 IF req% = 1 THEN 
   REM IF EXISTS (textvorlage$) THEN 
     SELECT KEY codeaq% LOCK FILE GAkquiDat$ INDEX codeaq.GAkquiDat$
     feld$ = "EMAILATT" + STR$ (nr%,"0") + "." + GAkquiDat$
     feld$$ = textvorlage$
     feld1$ = "EATT" + STR$ (nr%,"0") + "." + GAkquiDat$
     feld1$$ = zz$
     CALL QuickStore(GAkquiDat$)
   REM END IF 
 END IF 
EN070820061: 
 FORM 
 END SUB 
 
 
SUB ShowAtt(feld$)
 IF feld$ <> "" THEN 
   REM feld$ = feld$ + "." + GAkquiDat$
   REM inifile$ = feld$$
   a% = CALL ("_SBFileExists",feld$)
   IF a% = - 1 THEN 
     REM i% = CALL ("ShellExecute",0,"open",feld$,"","",1)
     CALL TextAnz(feld$)
   ELSE 
     CALL Fehler ("Datei: " + inifile$ + " nicht gefunden!","")
   END IF 
 END IF 
 END SUB 
 


SUB EMAILATTold(nr%)
 codeaq% = codeaq.GAkquiDat$
   IF MOD ("akquise") THEN STORE FILE "akquise"
   IF Gcodie% = - 1 THEN 
     textvorlage$ = "*.*"
     iniPath$ = GScanDir$
     IF inipath$ = "" THEN inipath$ = _ppath$
     REM IF inipath$ LIKE "" THEN iniPath$ = "C:\"
     REM REGISTER _netpath$ + "CODieLIB.dll","_SelectFile","IFFF"
     REM a% = CALL ("_SelectFile",texttitel$,iniPath$,textvorlage$)
     REM REGISTER CLEAR "_SelectFile"
     REM a% = CALL ("_SBFileExists",iniPath$)

     REM ********************************************************************
     inifile$ = GMACodeDir$ + "codiesf0.ini"
     exefile$ = GMACodeDir$ + "codiesf0.exe"
     a% = CALL ("_SBFileExists",inifile$)
     IF a% = - 1 THEN 
       a% = CALL ("_SBFileDelete1",inifile$)
     END IF 
 
     a% = 1
     CALL WriteINIDes("DATA","ScanDir",GScanDir$,inifile$)
     CALL WriteINIDes("DATA","Titel","Auswahl der zu importierenden Datei",inifile$)
     CALL WriteINIDes("DATA","Filter","*.*",inifile$)
     IF EXISTS (GMACodeDir$ + "sready.ini") THEN 
       DELETE GMACodeDir$ + "sready.ini"
     END IF 
     i% = CALL ("ShellExecute",0,"open",exefile$,"","",1)
     zz% = 0
     WHILE NOT EXISTS (GMACodeDir$ + "sready.ini")
       zz% = zz% + 1
       MOUSE OFF 
       WAIT FOR 1
       IF zz% = 60 THEN 
         CALL Fehler("Irgendwas ist beim ôffnendialog schiefgegangen!","")
         GOTO w230120055
       END IF 
     WEND 
     inipath$ = ReadINIDes$("DATA","Importfile",inifile$)
     a% = - 1
     IF inipath$ = "" OR inipath$ LIKE "leer" THEN 
       CALL Fehler("Es wurde keine zu importierende Datei ausgewÑhlt!","Der Import abgebrochen!")
       GOTO EN070820061
     END IF 
     REM ********************************************************************

     DIRECTORY cdir$
     IF a% = - 1 THEN 
       REQUEST "Erstelle Arbeitskopie der zu versendenden Datei","",2
       SET STATUS "Erstelle Arbeitskopie der zu versendenden Datei"
       MOUSE OFF 
       endung$ = GetDateiendung$(iniPath$)
       REM zz$ = GMACodeDir$ + STR$ (codeaq%,"000000") + "-" + STR$ (nr%,"0") + "." + endung$
       zz$ = _netpath$ + "EMAILATT\" + STR$ (codeaq%,"000000") + "-" + STR$ (nr%,"0") + "." + endung$
       REM IF EXISTS (zz$) THEN DELETE zz$
       a% = CALL ("_SBFileExists",zz$)
       IF a% = - 1 THEN 
         a% = CALL ("_SBFileDelete1",zz$)
       END IF 
       a% = CALL ("_SBFileCopy",iniPath$,zz$)
       textvorlage$ = FN ansi(iniPath$)
       req% = 1
       MOUSE ON 
       SET STATUS ""
     END IF 
   ELSE 
     REQUEST "Datei auswÑhlen","",26,req%,textvorlage$
   END IF 
 IF req% = 1 THEN 
   REM IF EXISTS (textvorlage$) THEN 
     SELECT KEY codeaq% LOCK FILE GAkquiDat$ INDEX codeaq.GAkquiDat$
     feld$ = "EMAILATT" + STR$ (nr%,"0") + "." + GAkquiDat$
     feld$$ = textvorlage$
     feld1$ = "EATT" + STR$ (nr%,"0") + "." + GAkquiDat$
     feld1$$ = zz$
     CALL QuickStore(GAkquiDat$)
   REM END IF 
 END IF 
EN070820061: 
 FORM 
 END SUB 

SUB ShowAtt(feld$)
 IF feld$ <> "" THEN 
   REM feld$ = feld$ + "." + GAkquiDat$
   REM inifile$ = feld$$
   a% = CALL ("_SBFileExists",feld$)
   IF a% = - 1 THEN 
     i% = CALL ("ShellExecute",0,"open",feld$,"","",1)
   ELSE 
     CALL Fehler ("Datei: " + inifile$ + " nicht gefunden!","")
   END IF 
 END IF 
 END SUB 
 
 REM Duplizieren einer email(Termin)
SUB EMAILDupli(codeaq%)
 FILE "Telefon"
 INDEX codeku.telefon
 FILE "Adressen"
 INDEX codeku.adressen
 FILE "akquise"
 INDEX codeaq.akquise
 SELECT FIRST FILE "akquise" INDEX codeaq.akquise
 SELECT KEY codeaq% FILE "akquise" INDEX codeaq.akquise
 REQUEST "Soll dieser neue Emailsendetermin einer","anderen Adresse zugeordnet werden?",130,req%
 IF req% = 1 THEN 
   adr% = ADRSuche%(0)
   IF adr% > 0 THEN 
     SELECT FIRST FILE "adressen" INDEX codeku.adressen
     SELECT KEY adr% FILE "adressen" INDEX codeku.adressen
     codeku% = adr%
     
   END IF 
 ELSE 
   SELECT FIRST FILE "adressen" INDEX codeku.adressen
   SELECT KEY codeku.akquise FILE "adressen" INDEX codeku.adressen
   codeku% = codeku.akquise
 END IF 
 knr% = codeku%
   DIM Telefonliste$(300)
    FILE "Telefon"
   GTelDat$ = "Telefon"
   INDEX CodeKU
   SELECT FIRST 
   SELECT KEY codeku%
   a% = 0
   prompt$ = "ZZZZZZ"
   WHILE CodeKU.GTelDat$ = codeku% AND NOT EOF (GTelDat$)
     IF art.telefon LIKE "email*" OR art.telefon LIKE "@" OR nummer.telefon LIKE "*@*" OR kart1.telefon LIKE "email" THEN 
       Telefonliste$(a%) = Art.GTelDat$ + ", " + Nummer.GTelDat$ + "," + KART1.GTelDat$ + "," + Kart2.GTelDat$ + SPACE$ (80) + STR$ (CodeTEL.GTelDat$,"000000")
       IF Telefonliste$(a%) < prompt$ THEN prompt$ = Telefonliste$(a%)
       a% = a% + 1
     END IF 
     SELECT NEXT FILE "Telefon"
   WEND 
   TelefonListe$(a%) = ""
   Kunde$ = Nachname.GAdrDat$ + ", " + Vorname.GAdrDat$
   nummer$ = ""
   CREATE DIALOG "KEYWORD",0,0,333,200,title$,"MS Sans Serif",8
   ADD DIALOG "KEYWORD",4,0,1,333,176,0,""
   ADD DIALOG "KEYWORD",9,4,12,21,24,2
   ADD DIALOG "KEYWORD",5,31,14,189,19,0,"Bitte wÑhlen Sie den Eintrag aus, der in die aktuelle Adresse aufgenommen werden soll:"
   ADD DIALOG "KEYWORD",7,5,38,320,132,2,2,TelefonListe$,Auswahl$,prompt$
   ADD DIALOG "KEYWORD",1,57,182,55,15,1,"&OK",1,1
   ADD DIALOG "KEYWORD",1,113,182,55,15,0,"&Abbrechen",0,0
   DIALOG "KEYWORD",req%
   REMOVE DIALOG "KEYWORD"
   IF req% = 1 THEN 
     codetel% = VAL ( RIGHT$ (Auswahl$(0),6))
     FILE "telefon"
     INDEX codetel.telefon
     SELECT FIRST FILE "telefon" INDEX codetel.telefon
     SELECT KEY codetel% FILE "telefon" INDEX codetel.telefon
     nummer$ = nummer.telefon
   END IF 

 MOUSE OFF 
 FILE "Telefon"
 INDEX codeku.telefon
 FILE "Akquise"
 BLANK DUPLICATE 
 codeaqneu% = SER ("Akquise",1)
 codeaq.akquise = codeaqneu%
 codeku.akquise = codeku%
 emailto.akquise = nummer$
 EMAILRAUS.akquise = "n"
 EMAILSendDat.akquise = 0
 EMAILSendZeit.akquise = 0
 CALL QuickStore("Akquise")
 FILE "akquise"
 INDEX codeku.akquise
 SELECT KEY codeku% FILE "telefon" INDEX codeku.telefon
 SELECT FORM KEY codeku% FILE "akquise" INDEX codeku.akquise
 FORM 
 END SUB 


 
 REM EMAIL manuell versenden aus "Akquise heraus"
SUB EMAILManSend(codeaq%,schalter%)
 IF GCODie% <> - 1 THEN 
   CALL Fehler("EMAIL - Versand wurde nicht konfiguriert!","")
   GOTO e120520031
 END IF 
 IF GEMAIL% <> - 1 THEN 
   CALL Fehler("EMAIL - Versand wurde fÅr diesen Nutzer nicht konfiguriert!","")
   GOTO e120520031 
 END IF 
 GAkquiDat$ = "AKQUISE"
 GADRDat$ = "ADRESSEN"
  IF NOT OPEN ("adressen") THEN CALL DFile(2,"OFFICE\adressen" + _fpw$)
  IF NOT OPEN ("akquise") THEN CALL DFile(2,"OFFICE\akquise" + _fpw$)
 codemaold% = codema.supervis
 codema% = codema.GAkquiDat$
 REM codema% = GMAcodema%
    FILE "akquise"
   INDEX codeaq.akquise
   FILE "ADRESSEN"
   INDEX codeku.adressen
   FILE "supervis"
   INDEX codema.supervis
 SELECT FIRST FILE "Supervis" INDEX codema.supervis
 SELECT KEY codema% FILE "Supervis" INDEX codema.supervis
 SELECT FIRST FILE GAkquiDat$ INDEX codeaq.GAkquiDat$
 SELECT KEY codeaq% LOCK FILE GAkquiDat$ INDEX codeaq.GAkquiDat$
 SELECT FIRST FILE GADRDat$ INDEX codeku.GADRDat$
 SELECT KEY codeku.GAkquiDat$ FILE GADRDat$ INDEX codeku.GADRDat$
 adresse$ = Nachname.adressen + "-" + Vorname.adressen
 datei$ = GMACodeDir$ + "codietes.ini"
 ateus$ = name.supervis
 IF EXISTS (datei$) THEN 
   ON ERROR GOTO mas070520031
   DELETE datei$
   GOTO mas070520032
mas070520031: 
   IF schalter% <> 0 THEN CALL fehler("Es konnte die temporÑre Datei " + datei$ + " nicht gelîscht werden, bitte prÅfen Sie, ob die Datei geîffnet ist und schlie·en Sie diese!,"")
mas070520032: 
   ON ERROR GOTO ErrorHandler
 END IF 
 datei1$ = GMACodeDir$ + "codietes.txt"
 IF EXISTS (datei1$) THEN 
   ON ERROR GOTO mas070520035
   DELETE datei1$
   GOTO mas070520036
mas070520035: 
   IF schalter% <> 0 THEN CALL fehler("Es konnte die temporÑre Datei " + datei1$ + " nicht gelîscht werden, bitte prÅfen Sie, ob die Datei geîffnet ist und schlie·en Sie diese!,"")
mas070520036: 
   ON ERROR GOTO ErrorHandler
 END IF 
 OPEN datei$ FOR OUTPUT 
 CLOSE OUTPUT 
 IF EmailShost.supervis <> "" THEN 
   Host$ = FN ANSI(EMAILSHost.supervis)
   UserID$ = FN ANSI(EMAILSUserID.supervis)
   AFirma$ = FN ansi(EMAILSAFirma.supervis)
   AName$ = FN ansi(EMAILSAName.supervis)
   ANUmmer$ = FN ANSI(EMAILNummer.supervis)
   REM BCC$ = EMAILSKopie.supervis
   Sen$ = FN ANSI(EMAILSKopie.supervis)
   Hpop3$ = ""
   HPPort$ = ""
   PUID$ = ""
   Ppassw$ = ""
   PJN$ = EMAILPOP3JN.supervis
   IF EMAILPOP3JN.supervis = "TRUE" THEN 
     Hpop3$ = FN ANSI(EMAILPHost.supervis)
     HPPort$ = LTRIM$ ( STR$ (EMAILPPort.supervis,"999999"))
     IF HPPort$ = "" THEN HPPort$ = "110"
     PUID$ = FN ANSI(EmailPUserID.supervis)
     Ppassw$ = FN ANSI(EMAILPPasww.supervis)
   END IF 
   port$ = LTRIM$ ( STR$ (EMAILSPort.supervis,"999999"))
   IF port$ = "" THEN port$ = "25"
   IF EMAILSNummer.supervis <> "" THEN 
     Bersend$ = FN ANSI(EMAILSNummer.supervis)
   ELSE 
     Bersend$ = FN ANSI(EMAILNummer.supervis)
   END IF 
   Bersend1$ = FN ANSI(EMAILSNummer1.supervis)
   Text1$ = EMAILText1.supervis
   Text2$ = EMAILText2.supervis
   BAnrede$ = FN ansi(Briefanrede.GADRDat$)
   alltxt$ = GMACodeDir$ + "codietes.ini"
   fehler$ = ""
   TOM$ = FN ANSI(EMAILTO.GAkquiDat$)
   tom1$ = tom$
   IF TOM$ = "" THEN fehler$ = "Es wurde keine <Sende an> Emailadresse angegeben! Bitte ausfÅllen! / "
   Betreff$ = VSNRPackGK$(EMAILBETREFF.GAkquiDat$)
   IF Betreff$ = "" THEN fehler$ = fehler$ + "Es wurde keine Betreffzeile ausgefÅllt! Bitte ausfÅllen!"
   senber$ = UCASE$ (EMAILSErg.supervis)
   IF fehler$ <> "" THEN 
     CALL Fehler(fehler$,"Der EMAIL Versand wurde abgebrochen!")
     GOTO e120520031
   END IF 
   CALL WriteINIDes("EMAILSERVER","HOST",EMAILShost.supervis,datei$)
   CALL WriteINIDes("EMAILSERVER","PORT",port$,datei$)
   CALL WriteINIDes("EMAILSERVER","USERID",UserID$,datei$)
   CALL WriteINIDes("EMAILSERVER","ABSFirma",AFirma$,datei$)
   CALL WriteINIDes("EMAILSERVER","ABSName",AName$,datei$)
   CALL WriteINIDes("EMAILSERVER","ABSEMAIL",ANummer$,datei$)
   CALL WriteINIDes("EMAILSERVER","KOPIEANABSENDER",Sen$,datei$)
   CALL WriteINIDes("EMAILSERVER","BerSendenummer",BerSend$,datei$)
   CALL WriteINIDes("EMAILSERVER","BerSendenummer1",BerSend1$,datei$)
   CALL WriteINIDes("EMAILSERVER","TO",TOM$,datei$)
   CALL WriteINIDes("EMAILSERVER","SENDEBERICHT",senber$,datei$)
   CALL WriteINIDes("EMAILSERVER","Betreff",Betreff$,datei$)
 
   REM *****************************************************
     Gbodytxt$ = _netpath$ + STR$ (GMACodema%,"000000") + ".txt"
     sendtxt$ = _netpath$ + STR$ (GMACodema%,"000000") + "-1.txt"
     IF EXISTS (Gbodytxt$) THEN DELETE Gbodytxt$
     IF EXISTS (sendtxt$) THEN DELETE sendtxt$
     REM CALL Fehler("EMAIL1","")
     REM X%% = MK_Init%%()
     X%% = MK_SendServer%%(Host$,port$,UserID$,Ppassw$,SendServer$)
     REM Absender
     X%% = MK_SendFrom%%(ANUmmer$,SendFrom$)
     REM antworten an
     X%% = MK_SendReply%%(ANUmmer$,SendReply$)
     REM 0=klein,1=gro·
     X%% = MK_Priority%%(1,Priority$)
     X%% = MK_SendTo%%(TOM$,SendTo$)
     X%% = MK_XHeader%%("xxPower mailer",SendHeader$)
     GMailBetreff$ = VSNRPackGK$(Betreff$)
     X%% = MK_Subject%%(GMailBetreff$,SendSubject$)
     REM emailtext$ = emailtext.GAkquiDat$ + emailtext1.GAkquiDat$
     CALL MK_WriteBodyN(emailtext.GAkquiDat$)
     CALL MK_WriteBodyN(emailtext1.GAkquiDat$)
     GOTO w111020055
     IF emailtext.GAkquiDat$ LIKE "*" + Text1$ + "*" THEN 
     ELSE 
       IF text1$ <> "" THEN 
         CALL MK_WriteBodyN("")
         CALL MK_WriteBodyN("")
         CALL MK_WriteBodyN(Text1$)
       END IF 
     END IF 
     IF emailtext.GAkquiDat$ LIKE "*" + text2$ + "*" THEN 
     ELSE 
       IF Text2$ <> "" THEN 
         CALL MK_WriteBodyN("")
         CALL MK_WriteBodyN("")
         CALL MK_WriteBodyN(Text2$)
       END IF 
     END IF 
w111020055: 
     sen$ = "TRUE"
     bccx$ = ""
     IF Sen$ LIKE "TRUE" THEN 
       bccx$ = ANUmmer$ + ","
     END IF 
   OPEN datei1$ FOR OUTPUT 
   ? FN ansi(emailtext.GAkquiDat$ + emailtext1.GAkquiDat$)
   CLOSE OUTPUT 
   ccx$ = ""
   IF emailcc.GAkquiDat$ <> "" THEN 
     ccx$ = emailcc.GAkquiDat$
     X%% = MK_SendCC%%(emailcc.GAkquiDat$,SendCC$)
     pos% = INSTR (emailcc.GAkquiDat$,";")
     IF pos% > 0 THEN 
       laeng% = LEN (emailcc.GAkquiDat$)
       j% = 0
       FOR i% = 1 TO laeng%
         posold% = pos%
         cc$ = MID$ (emailcc.GAkquiDat$,i%,pos% - i%)
         pos% = INSTR (posold% + 1,emailcc.GAkquiDat$,";")
 
         IF pos% > 0 THEN 
           i% = posold%
         ELSE 
           i% = laeng% + 1
         END IF 
         REM CALL WriteINIDes("CC","Z" + LTRIM$ ( STR$ (j%,"999")), FN ansi(CC$),datei$)
         
         j% = j% + 1
       NEXT i%
     ELSE 
       CALL WriteINIDes("CC","Z0", FN ansi(emailcc.GAkquiDat$),datei$)
     END IF 
   END IF 
   IF emailbcc.GAkquiDat$ <> "" OR bccx$ <> "" THEN 
     bccx$ = bccx$ + emailbcc.GAkquiDat$
     X%% = MK_SendBCC%%(bccx$,SendBCC$)
     pos% = INSTR (emailbcc.GAkquiDat$,";")
     IF pos% > 0 THEN 
       laeng% = LEN (emailbcc.GAkquiDat$)
       j% = 0
        FOR i% = 1 TO laeng%
         posold% = pos%
         cc$ = MID$ (emailbcc.GAkquiDat$,i%,pos% - i%)
         pos% = INSTR (posold% + 1,emailbcc.GAkquiDat$,";")
 
         IF pos% > 0 THEN 
           i% = posold%
         ELSE 
           i% = laeng% + 1
         END IF 
         CALL WriteINIDes("BCC","Z" + LTRIM$ ( STR$ (j%,"999")), FN ansi(CC$),datei$)
         j% = j% + 1
       NEXT i%
     ELSE 
       CALL WriteINIDes("BCC","Z0", FN ansi(emailbcc.GAkquiDat$),datei$)
     END IF 
   END IF 
   ok% = - 1
   IF emailatt1.GAkquiDat$ <> "" OR eatt1.GAkquiDat$ <> "" THEN 
     IF Gcodie% = - 1 THEN 
       iniPath$ = emailatt1.GAkquiDat$
       IF eatt1.GAkquiDat$ <> "" THEN iniPath$ = eatt1.GAkquiDat$
       a% = CALL ("_SBFileExists",iniPath$)
       IF a% = - 1 THEN 
         CALL WriteINIDes("AT","Z0", FN ansi(iniPath$),datei$)
         X%% = MK_Attach%%(iniPath$,AttachString$)
         at1$ = iniPath$
         attachges$ = attachges$ + at1$ + " ,"
       ELSE 
         at1$ = ""
         ok% = 0
         fehl$ = "Dateianhang 1 nicht gefunden "
       END IF 
     ELSE 
       IF EXISTS (emailatt1.GAkquiDat$) THEN 
         CALL WriteINIDes("AT","Z0", FN ansi(emailatt1.GAkquiDat$),datei$)
         X%% = MK_Attach%%(emailatt1.GAkquiDat$,AttachString$)
         at1$ = emailatt1.GAkquiDat$
         attachges$ = attachges$ + at1$ + " ,"
       ELSE 
         at1$ = ""
         ok% = 0
         fehl$ = "Dateianhang 1 nicht gefunden "
       END IF 
     END IF 
   END IF 


   IF emailatt2.GAkquiDat$ <> "" OR eatt2.GAkquiDat$ <> "" THEN 
     IF Gcodie% = - 1 THEN 
       iniPath$ = emailatt2.GAkquiDat$
       IF eatt2.GAkquiDat$ <> "" THEN iniPath$ = eatt2.GAkquiDat$
       a% = CALL ("_SBFileExists",iniPath$)
       IF a% = - 1 THEN 
         CALL WriteINIDes("AT","Z1", FN ansi(iniPath$),datei$)
         X%% = MK_Attach%%(iniPath$,AttachString$)
         at1$ = iniPath$
         attachges$ = attachges$ + at1$ + " ,"
       ELSE 
         at1$ = ""
         ok% = 0
         fehl$ = "Dateianhang 2 nicht gefunden "
       END IF 
     ELSE 
       IF EXISTS (emailatt2.GAkquiDat$) THEN 
         CALL WriteINIDes("AT","Z1", FN ansi(emailatt2.GAkquiDat$),datei$)
         X%% = MK_Attach%%(emailatt2.GAkquiDat$,AttachString$)
         at1$ = emailatt2.GAkquiDat$
         attachges$ = attachges$ + at1$ + " ,"
       ELSE 
         at1$ = ""
         ok% = 0
         fehl$ = "Dateianhang 2 nicht gefunden "
       END IF 
     END IF 
   END IF 


   IF emailatt3.GAkquiDat$ <> "" OR eatt3.GAkquiDat$ <> "" THEN 
     IF Gcodie% = - 1 THEN 
       iniPath$ = emailatt3.GAkquiDat$
       IF eatt3.GAkquiDat$ <> "" THEN iniPath$ = eatt3.GAkquiDat$
       a% = CALL ("_SBFileExists",iniPath$)
       IF a% = - 1 THEN 
         CALL WriteINIDes("AT","Z2", FN ansi(iniPath$),datei$)
         X%% = MK_Attach%%(iniPath$,AttachString$)
         at1$ = iniPath$
         attachges$ = attachges$ + at1$ + " ,"
       ELSE 
         at1$ = ""
         ok% = 0
         fehl$ = "Dateianhang 3 nicht gefunden "
       END IF 
     ELSE 
       IF EXISTS (emailatt3.GAkquiDat$) THEN 
         CALL WriteINIDes("AT","Z2", FN ansi(emailatt3.GAkquiDat$),datei$)
         X%% = MK_Attach%%(emailatt3.GAkquiDat$,AttachString$)
         at1$ = emailatt3.GAkquiDat$
         attachges$ = attachges$ + at1$ + " ,"
       ELSE 
         at1$ = ""
         ok% = 0
         fehl$ = "Dateianhang 3 nicht gefunden "
       END IF 
     END IF 
   END IF 


   IF emailatt4.GAkquiDat$ <> "" OR eatt4.GAkquiDat$ <> "" THEN 
     IF Gcodie% = - 1 THEN 
       iniPath$ = emailatt4.GAkquiDat$
       IF eatt4.GAkquiDat$ <> "" THEN iniPath$ = eatt4.GAkquiDat$
       a% = CALL ("_SBFileExists",iniPath$)
       IF a% = - 1 THEN 
         CALL WriteINIDes("AT","Z3", FN ansi(iniPath$),datei$)
         X%% = MK_Attach%%(iniPath$,AttachString$)
         at1$ = iniPath$
         attachges$ = attachges$ + at1$ + " ,"
       ELSE 
         at1$ = ""
         ok% = 0
         fehl$ = "Dateianhang 4 nicht gefunden "
       END IF 
     ELSE 
       IF EXISTS (emailatt4.GAkquiDat$) THEN 
         CALL WriteINIDes("AT","Z3", FN ansi(emailatt4.GAkquiDat$),datei$)
         X%% = MK_Attach%%(emailatt4.GAkquiDat$,AttachString$)
         at1$ = emailatt4.GAkquiDat$
         attachges$ = attachges$ + at1$ + " ,"
       ELSE 
         at1$ = ""
         ok% = 0
         fehl$ = "Dateianhang 4 nicht gefunden "
       END IF 
     END IF 
   END IF 


   IF emailatt5.GAkquiDat$ <> "" OR eatt5.GAkquiDat$ <> "" THEN 
     IF Gcodie% = - 1 THEN 
       iniPath$ = emailatt5.GAkquiDat$
       IF eatt5.GAkquiDat$ <> "" THEN iniPath$ = eatt5.GAkquiDat$
       a% = CALL ("_SBFileExists",iniPath$)
       IF a% = - 1 THEN 
         CALL WriteINIDes("AT","Z4", FN ansi(iniPath$),datei$)
         X%% = MK_Attach%%(iniPath$,AttachString$)
         at1$ = iniPath$
         attachges$ = attachges$ + at1$ + " ,"
       ELSE 
         at1$ = ""
         ok% = 0
         fehl$ = "Dateianhang 5 nicht gefunden "
       END IF 
     ELSE 
       IF EXISTS (emailatt5.GAkquiDat$) THEN 
         CALL WriteINIDes("AT","Z4", FN ansi(emailatt5.GAkquiDat$),datei$)
         X%% = MK_Attach%%(emailatt5.GAkquiDat$,AttachString$)
         at1$ = emailatt5.GAkquiDat$
         attachges$ = attachges$ + at1$ + " ,"
       ELSE 
         at1$ = ""
         ok% = 0
         fehl$ = "Dateianhang 5 nicht gefunden "
       END IF 
     END IF 
   END IF 
   schalter$ = STR$ (schalter%,"0")
   REM CALL Fehler("MAIL","")
   REM CALL Fehler(datei$ + " " + datei1$ + " " + schalter$ + " " + adresse$ + " " + Hpop3$ + " " + PUID$ + " " + HPPort$ + " " + Ppassw$ + " " + PJN$,"")
   IF ok% THEN 
     MOUSE OFF 
     REM ret% = CALL ("_SendEMAILAuto",datei$,datei1$,schalter$,adresse$,Hpop3$,PUID$,HPPort$,Ppassw$,PJN$)
     X%% = MK_LogFile%%(GMACodeDir$ + "emailsen.log",LogDateiName$)
     X%% = MK_Html%%(0,Html$)
     SET STATUS "sende email"
     MOUSE OFF 
     X%% = MK_Init%%()
     X%% = MK_SendGo%%(RetVal%%,RetVal$,SendHeader$,SendTo$,SendFrom$,SendReply$,Priority$,SendCC$,SendBCC$,SendSubject$,LogDateiName$,SendServer$,AttachString$,Html$)
     X%% = MK_InitReset%%()
     Fehler$ = ""
     IF RetVal%% = 0 THEN 
       ret% = - 1
       REM REQUEST RetVal$,"",2
     ELSE 
       ret% = 1
       Fehler$ = RetVal$
       REM CALL Fehler(RetVal$,"")
     END IF 
 
    
 
     REM Sendebericht an 
     IF senber$ LIKE "TRUE" AND RetVal%% = 0 THEN 
       REM Sendebericht an BerSend$
       SET STATUS "sende Sendebericht"
       emailtext$ = emailtext.akquise + emailtext1.akquise
       MOUSE OFF 
       CALL SendeBer(Ppassw$,adresse$,TOM$,attachges$,ccx$,bccx$,Betreff$,emailtext$)
     END IF 
     SET STATUS ""
     MOUSE ON 
   ELSE 
     ret% = 4
   END IF 
   IF ret% = - 1 THEN 
     emailraus.GAkquiDat$ = "j"
     EMAILSendDat.akquise = TODAY 
     EMAILSendZeit.akquise = NOW 
     SELECT KEY GMACodema% FILE "supervis" INDEX codema.supervis
     IF EMAILAutomat.GAkquiDat$ = "j" THEN 
       text1$ = DATE$ (EMAILSendDat.GAkquiDat$,"0d.mm.yyyy") + " " + TIME$ (EMAILSendZeit.GAkquiDat$,"hh:mm") + " EMAIL wurde per Automatik von " + name.supervis + " gesendet "
     ELSE 
       text1$ = DATE$ (EMAILSendDat.GAkquiDat$,"0d.mm.yyyy") + " " + TIME$ (EMAILSendZeit.GAkquiDat$,"hh:mm") + " EMAIL wurde per Hand von " + name.supervis + " gesendet "
     END IF 
     text2$ = ""
     ergebnis.akquise = LEFT$ (ergebnis.akquise + CHR$ (13) + CHR$ (10) + text1$ + text2$,1500)
     STORE FILE GAkquiDat$
     REM CALL Fehler("emailTest","")
     GMailIn% = - 1
     GEMAILSer% = - 1
     textdatei% = DOKNeu%(0,"allgemeine Schreiben",0)
     GMailIn% = 0
     GEMAILSer% = 0
     textdatei$ = STR$ (textdatei%,6)
     textdatei% = VAL (textdatei$)
     IF EXISTS (textdatei%,CodeDOK.GDokDat$) AND textdatei% > 0 THEN 
       SELECT KEY textdatei% FILE GDokDat$ INDEX CodeDOK.GDokDat$
       datei1$ = _netpath$ + Dateiname.GDokDat$
       COPY Gbodytxt$ TO datei1$
       SELECT FIRST FILE GAkquiDat$ INDEX codeaq.GAkquiDat$
       SELECT KEY codeaq% LOCK FILE GAkquiDat$ INDEX codeaq.GAkquiDat$
       codedok.GAkquiDat$ = textdatei%
       nono$ = NOTiz.GAkquiDat$
       IF NOTiz.GAkquiDat$ LIKE "sende EMAIL :" THEN 
         NOTiz.GAkquiDat$ = NOTiz.GAkquiDat$ + Betreff$
         STORE FILE GAkquiDat$
       END IF 
     END IF 
 
     IF EXISTS (codeaq%,codeaq.tvorlage) THEN 
       SELECT KEY codeaq% LOCK FILE "TVORLAGE" INDEX codeaq.tvorlage
       emailraus.tvorlage = "j"
       STORE FILE "tvorlage"
     END IF 
     REM CALL Fehler(ergebnis.akquise,"")
   END IF 
   IF ret% = 1 THEN 
     text1$ = DATE$ ( TODAY ,"0d.mm.yyyy") + " " + TIME$ ( NOW ,"hh:mm") + " EMAIL sollte per Hand von <" + name.supervis + "> versandt, "
     text2$ = "werden, konnte aber nicht durchgefÅhrt werden, Fehlemeldung: " + Fehler$
     ergebnis.akquise = LEFT$ (ergebnis.akquise + CHR$ (13) + CHR$ (10) + text1$ + text2$,1500)
     STORE FILE GAkquiDat$
     CALL Fehler(text1$,text2$)
   END IF 
 ELSE 
   CALL Fehler("EMAIL kann nicht versendet werden, da fÅr den User " + Name.supervis + " das Feld <Host> nicht ausgefÅllt wurde!","")
 END IF 
 IF ret% <> 1 THEN 
   t2$ = "Bitte prÅfen Sie, ob Sie in Ihrem EMAIL-Posteingang eine Kopie der EMAIL erhalten haben. Wenn nicht, ist beim EMAIL Versand ein Fehler aufgetreten!"
   CALL Fehler("EMAIL wurde an " + tom1$ + " versandt! Eine Kopie wurde " + "zur Kontrolle an " + ANUmmer$ + " gesandt!",t2$)
 END IF 
e120520031: 
 END SUB 
  


 
 
SUB EMAILUsTest(codema%)
   REM SendEMAILTest(char *absenderemail,char *HostSMTP, char *UserIDSMTP, char *PortSMTP,
   REM  char * HostPOP3,char * UserIDPOP3,char * PortPOP3,char * PasswortPOP3,char * POPCon)
   REM SELECT FIRST FILE "Supervis" INDEX codema.supervis
   SELECT KEY codema% FILE "Supervis" INDEX codema.supervis
 
   REM SMTP
   Host$ = EMAILSHost.supervis
   UserID$ = EMAILSUserID.supervis
   ANUmmer$ = EMAILNummer.supervis
   port$ = LTRIM$ ( STR$ (EMAILSPort.supervis,"999999"))
   IF port$ = "" THEN port$ = "25"
   REM POP3
   Hpop3$ = ""
   HPPort$ = ""
   PUID$ = ""
   PJN$ = EMAILPOP3JN.supervis
   Ppassw$ = ""
   IF EMAILPOP3JN.supervis = "TRUE" THEN 
     Hpop3$ = EMAILPHost.supervis
     HPPort$ = LTRIM$ ( STR$ (EMAILPPort.supervis,"999999"))
     IF HPPort$ = "" THEN HPPort$ = "110"
     PUID$ = EmailPUserID.supervis
     Ppassw$ = EMAILPPasww.supervis
   END IF 
   ok% = - 1
   fehl$ = ""
   IF EMAILPOP3JN.supervis = "TRUE" THEN 
     IF LTRIM$ (HPOP3$) = "" THEN 
       ok% = 0
       fehl$ = fehl$ + "POP3 Host muss ausgefÅllt werden" + CHR$ (13) + CHR$ (10)
     END IF 
     IF LTRIM$ (PUID$) = "" THEN 
       ok% = 0
       fehl$ = fehl$ + "POP3 UserID muss ausgefÅllt werden" + CHR$ (13) + CHR$ (10)
     END IF 
     IF LTRIM$ (ANummer$) = "" THEN 
       ok% = 0
       fehl$ = fehl$ + "eigene EMAIL-Adresse muss fÅr POP3 ausgefÅllt werden" + CHR$ (13) + CHR$ (10)
     END IF 
   END IF 
   IF LTRIM$ (Host$) = "" THEN 
     ok% = 0
     fehl$ = fehl$ + "SMTP Host muss ausgefÅllt werden" + CHR$ (13) + CHR$ (10)
   END IF 
   IF LTRIM$ (UserID$) = "" THEN 
     ok% = 0
     fehl$ = fehl$ + "SMTP UserID muss ausgefÅllt werden" + CHR$ (13) + CHR$ (10)
   END IF 
   IF LTRIM$ (Host$) = "" THEN 
     ok% = 0
     fehl$ = fehl$ + "SMTP Host muss ausgefÅllt werden" + CHR$ (13) + CHR$ (10)
   END IF 
   IF ok% THEN 
     MOUSE OFF 
     REM ret% = CALL ("_SendEMAILTest",ANummer$,Host$,UserID$,port$,Hpop3$,PUID$,HPPort$,Ppassw$,PJN$)
     Gbodytxt$ = _netpath$ + STR$ (GMACodema%,"000000") + ".txt"
     IF EXISTS (Gbodytxt$) THEN DELETE Gbodytxt$
     X%% = MK_Init%%()
     X%% = MK_SendServer%%(Host$,port$,UserID$,Ppassw$,SendServer$)
     REM Absender
     X%% = MK_SendFrom%%(ANUmmer$,SendFrom$)
     REM antworten an
     X%% = MK_SendReply%%(ANUmmer$,SendReply$)
     REM 0=klein,1=gro·
     X%% = MK_Priority%%(1,Priority$)
     X%% = MK_SendTo%%(ANUmmer$,SendTo$)
     X%% = MK_XHeader%%("xxPower mailer",SendHeader$)
     REM X%% = MK_SendCC%%("technik@mis-software.de,service@mis-software.de",SendCC$)
     REM X%% = MK_SendBCC%%("ab@codie.com,send@codie.com",SendBCC$)
     X%% = MK_Subject%%("Test Email von CODie software products e.K.",SendSubject$)
     CALL MK_WriteBody0()' Text in Htmlformat . You must change the parameter to MK_Html%%(1,Html$)
     CALL MK_WriteBodyN("")
     CALL MK_WriteBodyN("")
     CALL MK_WriteBodyN(EMAILText1.supervis)
     CALL MK_WriteBodyN("")
     CALL MK_WriteBodyN("")
 
     CALL MK_WriteBodyN(EMAILText2.supervis)
 
     'CALL MK_WriteBody2()' Text NOT in Htmlformat . You must change the parameter to MK_Html%%(0,Html$)
     'X%% = MK_Attach%%( DIRECTORY + "\attach\email.pdf",AttachString$)
     'X%% = MK_Attach%%( DIRECTORY + "\attach\email_abc.pdf",AttachString$)
     X%% = MK_LogFile%%(GMACodeDir$ + "emailsend.log",LogDateiName$)
     X%% = MK_Html%%(0,Html$)
     MOUSE OFF 
     X%% = MK_SendGo%%(RetVal%%,RetVal$,SendHeader$,SendTo$,SendFrom$,SendReply$,Priority$,SendCC$,SendBCC$,SendSubject$,LogDateiName$,SendServer$,AttachString$,Html$)
     MOUSE ON 
     X%% = MK_InitReset%%()
 
     CALL Fehler(RetVal$,"")
     a% = CALL ("ShellExecute",0,"open",GMACodeDir$ + "emailsend.log","","",1)
     MOUSE ON 
     IF retval%% = 0 THEN CALL Fehler ("Es wurde eine Testemail an die Adresse " + ANummer$ + " gesendet!","Bitte prÅfen Sie, ob diese email angekommen ist!")
   ELSE 
     CALL Fehler(fehl$,"")
   END IF 
 END SUB 



 REM lîschen
SUB EMAILATTD(nr%)
 codeaq% = codeaq.GAkquiDat$
 IF MOD ("akquise") THEN STORE FILE "akquise"
 REQUEST "EMAIL Anhang wirklich lîschen?","",130,req%
 
 IF req% = 1 THEN 
   REM IF EXISTS (textvorlage$) THEN 
     SELECT KEY codeaq% LOCK FILE GAkquiDat$ INDEX codeaq.GAkquiDat$
     feld$ = "EMAILATT" + STR$ (nr%,"0") + "." + GAkquiDat$
     feld$$ = ""
     feld1$ = "EATT" + STR$ (nr%,"0") + "." + GAkquiDat$
     feld1$$ = ""
     CALL QuickStore(GAkquiDat$)
   REM END IF 
 END IF 
 FORM 
 END SUB 
 
 
 REM ******************************************************************************************
 REM FUNCTION DokSuchen%(codeku%,befehl$)SELECT WHERE codeku.dokument = knr% AND novi1.dokument = 0
 REM FUNCTION DokSuch2%(codeku%)
 
FUNCTION DokuGetNam$(codeku%)
    DokuGetNam$ = ""
    optemail% = 1
    FILE "dokument"
    SELECT WHERE FILE "dokument"
    befehl$ = "SELECT WHERE codeku.dokument = codeku% AND novi1.dokument = 0"
 
    DIM dlg1 AS Dialog
     DIM control AS DialogControl 
 
     Superbase.Dialogs.Add("Dialogname")
     SET dlg1 = Superbase.Dialogs.Dialogname
     dlg1.Move(0,0,230,123)
     dlg1.Caption = "Art des Serienbriefes"
     dlg1.FontName = "MS Sans Serif"
     dlg1.FontSize = 8
 
     SET control = dlg1.Add("DialogFrame1","DialogFrame")
     control.Move(2,8,228,84)
     control.Caption = " WÑhlen Sie eine Option "
 
     SET control = dlg1.Add("DialogOptionButton1","DialogOptionButton")
     control.Move(6,20,214,10)
     control.Caption = "Suche1 in eigener Dokumentendatei - aktueller Kunde"
     control.Bind("optemail%")
     control.ValueOn = 1
 
     SET control = dlg1.Add("DialogOptionButton2","DialogOptionButton")
     control.Move(6,32,214,10)
     control.Caption = "Suche1 in eigener Dokumentendatei"
     control.Bind("optemail%")
     control.ValueOn = 2
 
     SET control = dlg1.Add("DialogOptionButton3","DialogOptionButton")
     control.Move(6,44,214,10)
     control.Caption = "Suche2 in eigener Dokumentendatei - aktueller Kunde"
     control.Bind("optemail%")
     control.ValueOn = 3
 
     SET control = dlg1.Add("DialogOptionButton4","DialogOptionButton")
     control.Move(6,56,214,10)
     control.Caption = "Suche2 in eigener Dokumentendatei"
     control.Bind("optemail%")
     control.ValueOn = 4
 
     SET control = dlg1.Add("DialogOptionButton5","DialogOptionButton")
     control.Move(6,68,214,10)
     control.Caption = "externes Dokument"
     control.Bind("optemail%")
     control.ValueOn = 5
 
     SET control = dlg1.Add("DialogCommandButton1","DialogCommandButton")
     control.Move(59,98,43,16)
     control.Default = 1
     control.Caption = "OK"
     control.ReturnValue = 1
 
     SET control = dlg1.Add("DialogCommandButton2","DialogCommandButton")
     control.Move(105,98,42,16)
     control.Caption = "Abbruch"
     control.ReturnValue = 0
 
     DIALOG "Dialogname",reqemail%
     REMOVE DIALOG "Dialogname"
     FILE "dokument"
     IF reqemail% = 1 THEN 
       MOUSE OFF 
       SELECT CASE optemail%
         CASE 1
           REM Suche 1 im aktuellen Kunden
           codedok% = DokSuchen%(codeku%,befehl$)
           SELECT WHERE FILE "dokument"
           IF codedok% > 0 THEN 
             SELECT FIRST FILE "Dokument" INDEX codedok.dokument
             SELECT KEY codedok% FILE "Dokument" INDEX codedok.dokument
             DokuGetNam$ = _netpath$ + Dateiname.dokument
           END IF 
         CASE 2
           REM Suche 1
           codedok% = DokSuchen%(0,"")
           SELECT WHERE FILE "dokument"
           IF codedok% > 0 THEN 
             SELECT FIRST FILE "Dokument" INDEX codedok.dokument
             SELECT KEY codedok% FILE "Dokument" INDEX codedok.dokument
             DokuGetNam$ = _netpath$ + Dateiname.dokument
           END IF 
         CASE 3
           REM Suche 2 im aktuellen Kunden
           FILE "dokument"
           EXECUTE befehl$
           SELECT FIRST FILE "dokument"
           codedok% = DokSuch2%(codeku%)
           SELECT WHERE FILE "dokument"
           IF codedok% > 0 THEN 
             SELECT FIRST FILE "Dokument" INDEX codedok.dokument
             SELECT KEY codedok% FILE "Dokument" INDEX codedok.dokument
             DokuGetNam$ = _netpath$ + Dateiname.dokument
           END IF 
         CASE 4
           REM Suche 2
           codedok% = DokSuch2%(0)
           SELECT WHERE FILE "dokument"
           IF codedok% > 0 THEN 
             SELECT FIRST FILE "Dokument" INDEX codedok.dokument
             SELECT KEY codedok% FILE "Dokument" INDEX codedok.dokument
             DokuGetNam$ = _netpath$ + Dateiname.dokument
           END IF 
         CASE 5
           REM externes Dokument
           DokuGetNam$ = GetExtDoc$()
         END SELECT 
     END IF 
 REM ******************************************************************************************
 END FUNCTION 
 
 
 
FUNCTION GetExtDoc$()
 GetExtDoc$ = ""
   IF Gcodie% = - 1 THEN 
     textvorlage$ = "*.*"
     iniPath$ = GScanDir$
     IF inipath$ = "" THEN inipath$ = _ppath$
     inifile$ = GMACodeDir$ + "codiesf0.ini"
     exefile$ = GMACodeDir$ + "codiesf0.exe"
     a% = CALL ("_SBFileExists",inifile$)
     IF a% = - 1 THEN 
       a% = CALL ("_SBFileDelete1",inifile$)
     END IF 
 
     a% = 1
     CALL WriteINIDes("DATA","ScanDir",GScanDir$,inifile$)
     CALL WriteINIDes("DATA","Titel","Auswahl der zu importierenden Datei",inifile$)
     CALL WriteINIDes("DATA","Filter","*.*",inifile$)
     IF EXISTS (GMACodeDir$ + "sready.ini") THEN 
       DELETE GMACodeDir$ + "sready.ini"
     END IF 
     i% = CALL ("ShellExecute",0,"open",exefile$,"","",1)
     zz% = 0
     WHILE NOT EXISTS (GMACodeDir$ + "sready.ini")
       zz% = zz% + 1
       MOUSE OFF 
       WAIT FOR 1
       IF zz% = 60 THEN 
         CALL Fehler("Irgendwas ist beim ôffnendialog schiefgegangen!","")
         GOTO w230120055
       END IF 
     WEND 
w230120055: 
     inipath$ = ReadINIDes$("DATA","Importfile",inifile$)
     a% = - 1
     IF inipath$ = "" OR inipath$ LIKE "leer" THEN 
       CALL Fehler("Es wurde keine zu importierende Datei ausgewÑhlt!","Der Import abgebrochen!")
       GOTO EN140320081
     END IF 
     GetExtDoc$ = inipath$
   ELSE 
     textvorlage$ = ""
     REQUEST "Datei auswÑhlen","",26,req%,textvorlage$
     IF textvorlage$ <> "" THEN GetExtDoc$ = textvorlage$
   END IF 
EN140320081: 
 END FUNCTION 
 
FUNCTION DokSuch2%(codeku%)
 DokSuch2% = 0
 
 DOKGruppen$(0) = "<ALLE DOKUMENTENGRUPPEN>"
 DOKGruppen$(1) = "allgemeine Schreiben"
 CALL FillDokGruppe(1)
 a% = 0
 
 
 CREATE DIALOG "DOK",0,0,300,338,title$,"MS Sans Serif",8
 ADD DIALOG "DOK",9,2,4,22,23,2
 ADD DIALOG "DOK",5,26,11,236,9,0,"WÑhlen Sie eine Dokumentengruppe aus:"
 ADD DIALOG "DOK",7,25,25,263,250,2,2,DOKGruppen$,Auswahl$,Gruppe.dokument
 ADD DIALOG "DOK",6,25,300,98,11,128,0,Gsuna1$,50
 ADD DIALOG "DOK",2,130,300,28,10,0,"UND","J","N",Gund$
 ADD DIALOG "DOK",6,160,300,108,11,128,0,Gsuna2$,50
 ADD DIALOG "DOK",5,25,270,250,30,0,"Geben Sie hier bis zu 2 Bestandteile des Dokumentennamens ein, den Sie suchen: Die Begriffe kînne mit UND verknÅpft werden. Die Eingabe von Suchbegriffen ist optional!"
 
 ADD DIALOG "DOK",1,106,317,48,16,1,"&Weiter",1,1
 ADD DIALOG "DOK",1,158,317,48,16,0,"&Abbruch",0,0
 ADD DIALOG "DOK",1,210,317,48,16,0,"Alle",2,2
 DIALOG "DOK",req%
 REMOVE DIALOG "DOK"
 IF req% > 0 THEN 
   req% = DOKAusw1a%(Auswahl$(0),codeku%,req%)
   IF req% <> - 1 THEN 
     DokSuch2% = req%
   END IF 
 END IF 
 SELECT KEY DokSuch2% FILE "DOKUMENT" INDEX codeDok.DOKUMENT
 MOUSE OFF 
 DOKGruppen$(0) = "allgemeine Schreiben"
 CALL FillDokGruppe(0)
 a% = 0
 MOUSE ON 
 END FUNCTION 
 
 
FUNCTION DOKAusw1a%(filter$,linkfield%,alle%)
  IF alle% = 1 THEN alle$ = "n"
  IF alle% = 2 THEN alle$ = "j"
 CALL DFile(2,"OFFICE\dokument" + _fpw$)
 REM CALL DFile(2,"OFFICE\dokgrup" + _fpw$)
 CALL DFile(2,"OFFICE\adressen" + _fpw$)
 SET STATUS "Dokumenten-/Vorlagenauswahl"
 cfile$ = FILE 
 _cuko% = CodeKU.Adressen
 DOKAusw1a% = 0
 DIM DokList$(25000)
 REM 261198-1
a240120051: 
 FILE "Dokument"
 INDEX Gruppe.DOKUMENT
 SELECT FIRST 
 IF filter$ LIKE "<ALLE DOKUMENTENGRUPPEN>" THEN 
   filter$ = ""
   FILE "Dokument"
   INDEX codedok.DOKUMENT
 
 ELSE 
   SELECT FIRST FILE "DOKUMENT" INDEX Gruppe.DOKUMENT
   SELECT KEY filter$ FILE "DOKUMENT" INDEX Gruppe.DOKUMENT
   IF linkfield% > 0 THEN 
     FILE "Dokument"
     INDEX QuickCodekuGru.dokument
     filt$ = STR$ (linkfield%,"000000") + UCASE$ (filter$)
     SELECT FIRST FILE "DOKUMENT" INDEX QuickCodekuGru.dokument
     SELECT KEY filt$ FILE "DOKUMENT" INDEX QuickCodekuGru.dokument
   END IF 
 END IF 
 a% = 0
 
      IF GCODIE% = - 1 THEN 
        CALL SearchInitDo1("dokument")
      END IF 
 
   MOUSE OFF 
   IF filter$ <> "" AND linkfield% > 0 THEN WHILE NOT EOF ("DOKUMENT") AND QuickCodekuGru.dokument LIKE filt$
   IF filter$ <> "" AND linkfield% = 0 THEN WHILE NOT EOF ("DOKUMENT") AND Gruppe.DOKUMENT LIKE filter$
   IF filter$ = "" THEN WHILE NOT EOF ("DOKUMENT")
     ok% = - 1
     IF alle$ = "n" THEN 
       IF novi1.dokument = 1 THEN ok% = 0
     END IF 
     IF Gsuna1$ <> "" OR Gsuna2$ <> "" THEN 
       IF Gsuna1$ <> "" AND Gsuna2$ <> "" THEN 
         IF Gund$ = "J" THEN 
           REM beide suchbegriffe ausgefÅllt und mit UND verknÅpft
           IF dokument.dokument LIKE "*" + Gsuna1$ + "*" AND dokument.dokument LIKE "*" + Gsuna2$ + "*" THEN 
           ELSE 
             ok% = 0
           END IF 
         ELSE 
           IF dokument.dokument LIKE "*" + Gsuna1$ + "*" OR dokument.dokument LIKE "*" + Gsuna2$ + "*" THEN 
           ELSE 
             ok% = 0
           END IF 
         END IF 
       ELSE 
         IF Gsuna1$ <> "" THEN 
           IF dokument.dokument LIKE "*" + Gsuna1$ + "*" THEN 
           ELSE 
             ok% = 0
           END IF 
         END IF 
         IF Gsuna2$ <> "" THEN 
           IF dokument.dokument LIKE "*" + Gsuna2$ + "*" THEN 
           ELSE 
             ok% = 0
           END IF 
         END IF 
       END IF 
     END IF 
     IF ok% = - 1 THEN 
       IF filter$ <> "" THEN 
         IF Gruppe.DOKUMENT LIKE filter$ AND (linkfield% = 0 OR link.DOKUMENT = linkfield%) OR codeku.dokument = linkfield% THEN 
           IF CodeKU.DOKUMENT <> 0 THEN 
             SELECT KEY CodeKU.DOKUMENT FILE "ADRESSEN" INDEX CodeKU.ADRESSEN
             Name$ = Nachname.ADRESSEN + ", " + Vorname.ADRESSEN
           ELSE 
             Name$ = "(ohne Zuordnung)"
           END IF 
           IF GCODIE% = - 1 THEN CALL SearchVorbDO1("dokument")
           DokList$(a%) = Dokument.DOKUMENT + ", " + LTRIM$ ( DATE$ (erstellt_am.DOKUMENT,"0d.mm.yyyy")) + "/" + LTRIM$ ( DATE$ (letzte_Bearbeit.DOKUMENT,"0d.mm.yyyy")) + ", " + Name$ + SPACE$ (100) + STR$ (CodeDOK.DOKUMENT,"000000")
           a% = a% + 1
         END IF 
       ELSE 
         IF (linkfield% = 0 OR link.DOKUMENT = linkfield%) OR codeku.dokument = linkfield% THEN 
           IF CodeKU.DOKUMENT <> 0 THEN 
             SELECT KEY CodeKU.DOKUMENT FILE "ADRESSEN" INDEX CodeKU.ADRESSEN
             Name$ = Nachname.ADRESSEN + ", " + Vorname.ADRESSEN
           ELSE 
             Name$ = "(ohne Zuordnung)"
           END IF 
           IF GCODIE% = - 1 THEN CALL SearchVorbDO1("dokument")
           DokList$(a%) = Dokument.DOKUMENT + ", " + LTRIM$ ( DATE$ (erstellt_am.DOKUMENT,"0d.mm.yyyy")) + "/" + LTRIM$ ( DATE$ (letzte_Bearbeit.DOKUMENT,"0d.mm.yyyy")) + ", " + Name$ + SPACE$ (100) + STR$ (CodeDOK.DOKUMENT,"000000")
           a% = a% + 1
         END IF 
       END IF 
     END IF 
     SET STATUS STR$ (a%,",9999999") + " gefunden " + Dokument.DOKUMENT
     SELECT NEXT FILE "dokument"
   WEND 
 MOUSE ON 
 DOKAusw1a% = - 1
 IF a% <> 0 THEN 
   IF GCODIE% = - 1 THEN 
     c$ = "aa"
     req3% = 0
     DOKAuswahl% = 0
     REM CALL Fehler("","")
     req3% = CALL ("_SearchShow",c$)
     IF VAL (c$) <> 0 THEN 
       DOKAusw1a% = VAL (c$)
       ok% = 0
       SET STATUS "Dokument gefunden..."
     END IF 
     IF VAL (c$) = 0 AND req3% = 33 THEN 
       ret% = CALL ("_SearchClose")
       GCODieRuf% = 0
       GCODieRuf1% = 0
       GCODieRuf2% = 0
       alle$ = "j"
       req3% = 0
       GOTO a240120051
     END IF 
   ELSE 
     CREATE DIALOG "DOK",0,0,426,304,title$,"MS Sans Serif",8
     ADD DIALOG "DOK",4,0,0,426,280,0,""
     ADD DIALOG "DOK",5,40,12,160,10,0,"Bitte wÑhlen Sie das gewÅnschte Dokument aus:"
     ADD DIALOG "DOK",9,6,14,22,22,2
     ADD DIALOG "DOK",5,40,24,160,10,0,"Bezeichnung, erstellt/bearbeitet, Adressat"
     ADD DIALOG "DOK",7,19,35,400,239,2,1,DokList$,Auswahl$
     ADD DIALOG "DOK",1,210,287,55,15,0,"&Abbrechen",0,0
     ADD DIALOG "DOK",1,154,287,55,15,1,"&OK",1,1
     DIALOG "DOK",req%
     REMOVE DIALOG "DOK"
     IF req% = 1 THEN 
       DOKAusw1a% = VAL ( RIGHT$ (Auswahl$(0),6))
     END IF 
   END IF 
 ELSE 
   CALL Fehler("Keine Dokumente in dieser Gruppe gefunden!","")
 END IF 
 SELECT KEY _cuko% FILE "ADRESSEN" INDEX CodeKU.ADRESSEN
 FILE cfile$
 END FUNCTION 
 
  
  
 REM *****************************************************************************************************************
 REM                 WMAIL Form
 REM *****************************************************************************************************************
 
SUB WEMAILform()
 REM knr% = Codeku.adressen
 REM IF disabled%("DOKUMENT") THEN END SUB 
 CALL DFile(2,"OFFICE\dokument" + _fpw$)
 CALL DFile(2,"OFFICE\wemail" + _fpw$)
 CALL DFile(2,"OFFICE\akquise" + _fpw$)
 CALL DFile(2,"OFFICE\adressen" + _fpw$)
 REM CALL DFile(2,"OFFICE\dokgrup" + _fpw$)
 REM cudo% = CodeDOK.DOKUMENT
 REM knr% = Codeku.adressen
 _formend% = 0
 SET STATUS "Bereit"
 maske$ = "WMAIL"
 
 FILE "wemail"
 SELECT WHERE FILE "wemail"
 INDEX codekey.wemail
 SELECT FIRST 
 WHILE _formend% = 0
   AQsub% = 0
   IF UCASE$ ( FORM ) <> maske$ THEN 
     FILE "wemail"
     OPEN FORM GOFFForm$ + maske$
     SET STATUS "Werbe-Emailenverwaltung"
     CALL MNwemail()
     CALL wemailINT()
     FORM 
     SET DISPLAY ON 
     GAppName$ = _netpath$ + "DOCP\dokument.pdf"
   END IF 
   MENU ON 
   FORM 
   MOUSE ON 
   FORM 
   CALL ClearKBDBuffer()
   WAIT MOUSE OR KEY OR MENU 
    REM ** Tastencodes
   GET k$
   IF k$ = CHR$ (27) THEN _formend% = 1
 
   SELECT CASE AQsub%
   CASE 1
     REM Neu
     SELECT FIRST FILE "supervis" INDEX codema.supervis
     SELECT KEY GMACodema% FILE "supervis" INDEX codema.supervis
     BLANK FILE "wemail"
     codekey.wemail = SER ("wemail",1)
     Beschreibung.wemail = "NEU " + DATE$ ( TODAY ,"0d.mm.yyyy")
     REM EMAILText1.wemail = EMAILText1.supervis + CHR$ (13) + CHR$ (10) + CHR$ (13) + CHR$ (10) + EMAILText1.supervis
     Name.wemail = Name.supervis
     Datum.wemail = TODAY 
     Ersteller.wemail = Name.supervis
     EDatum.wemail = TODAY 
     STORE FILE "wemail"
     REM CALL wemailINT()
     codekey% = codekey.wemail
     SELECT FIRST FILE "wemail" INDEX codekey.wemail
     SELECT KEY codekey% LOCK FILE "wemail" INDEX codekey.wemail
     FORM 2
     ENTER Beschreibung.wemail,0
   CASE 101
     REM gehe zu einzelne email
     codekey% = codekey.wemail
     SELECT FIRST FILE "wemail" INDEX codekey.wemail
     SELECT KEY codekey% LOCK FILE "wemail" INDEX codekey.wemail
     FORM 2
   CASE 3
     codekey% = codekey.wemail
     IF MOD ("wemail") OR NEW ("wemail") THEN STORE FILE "wemail"
     SELECT FIRST FILE "wemail" INDEX codekey.wemail
     SELECT KEY codekey% LOCK FILE "wemail" INDEX codekey.wemail
     REM CALL EMAILSerSend(CodeKey%)
   CASE 4
     REM Lîschen
     FILE "wemail"
     codekey% = codekey.wemail
     SELECT FIRST FILE "wemail" INDEX codekey.wemail
     SELECT KEY codekey% LOCK FILE "wemail" INDEX codekey.wemail
     REQUEST "Wirklich lîschen?","",130,req%
     IF req% = 1 THEN 
       SELECT REMOVE FILE "wemail"
       CALL Fehler("Datensatz wurde gelîscht!","")
       FORM 1
       FORM 
     END IF 
   CASE 5
     REM refresh
     codekey% = codekey.wemail
     CALL QuickStore("wemail")
     FORM 1
     REM SELECT FIRST FILE "wemail" INDEX codekey.wemail
     SELECT FORM FIRST FILE "wemail" INDEX codekey.wemail
     FORM 
   CASE 6
     REM Sortierung nach Beschreibung
     maske$ = "WMAIL"
   CASE 7
     REM Sortierung nach Bearbeiter
     maske$ = "WMAIL1"
   CASE 8
     REM Sortierung nach TimeStamp
     maske$ = "WMAIL2"
   CASE 9
     REM Sortierung nach Erstellung
     maske$ = "WMAIL3"
   CASE 10
     REM Druck
     CALL WEMAILV(codekey.wemail)
   CASE 99
     ENTER Beschreibung.wemail,0
   END SELECT 
 WEND 
 _formend% = 0
 REM IF FileChanged%("wemail") = 1 THEN CALL FStore("wemail")
 SELECT WHERE FILE "wemail"
 END SUB 
 
 
SUB MNwemail()
 CALL MNProgramm()
 MENU 2,0,1,"&Option","",""
 MENU 2,1,1,"aus Suchliste auswÑhlen,F7","DokKurzSuche",""
 CALL MNHilfe(3)
 END SUB 
 
SUB wemailINT()
 REM SELECT FORM KEY knr% FILE "Adressen" INDEX codeku.adressen
 REM SELECT FORM KEY knr% FILE "wemail" INDEX codeku.wemail
 SELECT FORM FIRST FILE "wemail"
 END SUB 
 
 
 
SUB wemailATTE(nr%)
 codekey% = codekey.wemail
 IF MOD ("wemail") OR NEW ("wemail") THEN STORE FILE "wemail"
 SELECT FIRST FILE "wemail" INDEX codekey.wemail
 SELECT KEY codekey% LOCK FILE "wemail" INDEX codekey.wemail
 REQUEST "Datei auswÑhlen","",26,req%,textvorlage$
 IF req% = 1 THEN 
   REM IF EXISTS (textvorlage$) THEN 
   a% = CALL ("_SBFileExists",textvorlage$)
   IF a% = - 1 THEN 
     SELECT KEY codekey% LOCK FILE "wemail" INDEX codekey.wemail
     feld$ = "EMAILATT" + LTRIM$ ( STR$ (nr%,"99")) + ".wemail"
     feld$$ = textvorlage$
     CALL QuickStore("wemail")
   END IF 
 END IF 
 FORM 
 END SUB 
 
SUB wEMAILATT(nr%)
 codekey% = codekey.wemail
   IF MOD ("wemail") THEN STORE FILE "wemail"
   IF Gcodie% = - 1 THEN 
     textvorlage$ = "*.*"
     iniPath$ = GScanDir$
     IF inipath$ = "" THEN inipath$ = _ppath$
     REM IF inipath$ LIKE "" THEN iniPath$ = "C:\"
     REM REGISTER _netpath$ + "CODieLIB.dll","_SelectFile","IFFF"
     REM a% = CALL ("_SelectFile",texttitel$,iniPath$,textvorlage$)
     REM REGISTER CLEAR "_SelectFile"
     REM a% = CALL ("_SBFileExists",iniPath$)
 
     REM ********************************************************************
     inifile$ = GMACodeDir$ + "codiesf0.ini"
     exefile$ = GMACodeDir$ + "codiesf0.exe"
     a% = CALL ("_SBFileExists",inifile$)
     IF a% = - 1 THEN 
       a% = CALL ("_SBFileDelete1",inifile$)
     END IF 
 
     a% = 1
     CALL WriteINIDes("DATA","ScanDir",GScanDir$,inifile$)
     CALL WriteINIDes("DATA","Titel","Auswahl der zu importierenden Datei",inifile$)
     CALL WriteINIDes("DATA","Filter","*.*",inifile$)
     IF EXISTS (GMACodeDir$ + "sready.ini") THEN 
       DELETE GMACodeDir$ + "sready.ini"
     END IF 
     i% = CALL ("ShellExecute",0,"open",exefile$,"","",1)
     zz% = 0
     WHILE NOT EXISTS (GMACodeDir$ + "sready.ini")
       zz% = zz% + 1
       MOUSE OFF 
       WAIT FOR 1
       IF zz% = 60 THEN 
         CALL Fehler("Irgendwas ist beim ôffnendialog schiefgegangen!","")
         GOTO w230120055
       END IF 
     WEND 
     inipath$ = ReadINIDes$("DATA","Importfile",inifile$)
     a% = - 1
     IF inipath$ = "" OR inipath$ LIKE "leer" THEN 
       CALL Fehler("Es wurde keine zu importierende Datei ausgewÑhlt!","Der Import abgebrochen!")
       GOTO EN210220071
     END IF 
     REM ********************************************************************
 
     DIRECTORY cdir$
     IF a% = - 1 THEN 
       REQUEST "Erstelle Arbeitskopie der zu versendenden Datei","",2
       SET STATUS "Erstelle Arbeitskopie der zu versendenden Datei"
       MOUSE OFF 
       endung$ = GetDateiendung$(iniPath$)
       REM zz$ = GMACodeDir$ + STR$ (codeaq%,"000000") + "-" + STR$ (nr%,"0") + "." + endung$
       zz$ = _netpath$ + "EMAILATT\" + STR$ (codekey%,"0000000") + STR$ (nr%,"0") + "." + endung$
       REM IF EXISTS (zz$) THEN DELETE zz$
       a% = CALL ("_SBFileExists",zz$)
       IF a% = - 1 THEN 
         a% = CALL ("_SBFileDelete1",zz$)
       END IF 
       a% = CALL ("_SBFileCopy",iniPath$,zz$)
       textvorlage$ = FN ansi(iniPath$)
       req% = 1
       MOUSE ON 
       SET STATUS ""
     END IF 
   ELSE 
     REQUEST "Datei auswÑhlen","",26,req%,textvorlage$
   END IF 
 IF req% = 1 THEN 
   REM IF EXISTS (textvorlage$) THEN 
     SELECT KEY codekey% LOCK FILE "wemail" INDEX codekey.wemail
     feld$ = "EMAILATT" + STR$ (nr%,"0") + ".wemail"
     feld$$ = textvorlage$
     feld1$ = "EATT" + STR$ (nr%,"0") + ".wemail"
     feld1$$ = zz$
     CALL QuickStore("wemail")
   REM END IF 
 END IF 
EN210220071: 
 FORM 
 END SUB 
 
SUB wShowAtt(feld$)
 REM feld$ = feld$ + ".wemail"
 IF feld$ <> "" THEN 
   REM feld$ = feld$ + "." + GAkquiDat$
   REM inifile$ = feld$$
   a% = CALL ("_SBFileExists",feld$)
   IF a% = - 1 THEN 
     REM i% = CALL ("ShellExecute",0,"open",feld$,"","",1)
     CALL TextAnz(feld$)
   ELSE 
     CALL Fehler ("Datei: " + inifile$ + " nicht gefunden!","")
   END IF 
 END IF 
 END SUB 
 
 REM lîschen
SUB WMAILATTD(nr%)
 codekey% = codekey.wemail
 IF MOD ("wemail") THEN STORE FILE "wemail"
 REQUEST "EMAIL Anhang wirklich lîschen?","",130,req%
 
 IF req% = 1 THEN 
   REM IF EXISTS (textvorlage$) THEN 
     SELECT KEY codekey% LOCK FILE "wemail" INDEX codekey.wemail
     feld$ = "EMAILATT" + STR$ (nr%,"0") + "." + "wemail"
     feld$$ = ""
     feld1$ = "EATT" + STR$ (nr%,"0") + "." + "wemail"
     feld1$$ = ""
     CALL QuickStore("wemail")
   REM END IF 
 END IF 
 FORM 
 END SUB 
  
 REM *****************************************************************************************************************
 REM                 EMAIL Form
 REM *****************************************************************************************************************
 
SUB EMAILform()
 REM knr% = Codeku.adressen
 REM IF disabled%("DOKUMENT") THEN END SUB 
 CALL DFile(2,"OFFICE\dokument" + _fpw$)
 CALL DFile(2,"OFFICE\email" + _fpw$)
 CALL DFile(2,"OFFICE\akquise" + _fpw$)
 CALL DFile(2,"OFFICE\adressen" + _fpw$)
 REM CALL DFile(2,"OFFICE\dokgrup" + _fpw$)
 REM cudo% = CodeDOK.DOKUMENT
 REM knr% = Codeku.adressen
 _formend% = 0
 SET STATUS "Bereit"
 maske$ = "EMAIL"
 IF ProjectJN$ = "TRUE" THEN maske$ = "EMAIL"
 
 FILE "EMAIL"
 SELECT WHERE FILE "EMAIL"
 INDEX codeku.EMAIL
 SELECT FIRST 
 WHILE _formend% = 0
   AQsub% = 0
   IF UCASE$ ( FORM ) <> maske$ THEN 
     FILE "email"
     OPEN FORM GOFFForm$ + maske$
     SET STATUS "Emailenverwaltung"
     CALL MNEMAIL()
     CALL EMAILINT()
     FORM 
     SET DISPLAY ON 
     GAppName$ = _netpath$ + "DOCP\dokument.pdf"
   END IF 
   MENU ON 
   FORM 
   MOUSE ON 
   FORM 
   CALL ClearKBDBuffer()
   WAIT MOUSE OR KEY OR MENU 
    REM ** Tastencodes
   GET k$
   IF k$ = CHR$ (27) THEN _formend% = 1
 
   SELECT CASE AQsub%
   CASE 1
     REM Neu
     BLANK FILE "email"
     codekey.email = SER ("email",1)
     EMAILBETREFF.email = "NEU " + DATE$ ( TODAY ,"0d.mm.yyyy")
     STORE FILE "email"
     CALL EMAILINT()
     FORM 
   CASE 2
     REM gehe zu einzelne email
     codekey% = codekey.email
     SELECT FIRST FILE "email" INDEX codekey.email
     SELECT KEY codekey% LOCK FILE "email" INDEX codekey.email
     FORM 2
   CASE 3
     codekey% = codekey.email
     IF MOD ("email") OR NEW ("email") THEN STORE FILE "email"
     SELECT FIRST FILE "email" INDEX codekey.email
     SELECT KEY codekey% LOCK FILE "email" INDEX codekey.email
     CALL EMAILSerSend(CodeKey%)
   CASE 99
     ENTER emailbetreff.email,0
   END SELECT 
 WEND 
 _formend% = 0
 REM IF FileChanged%("email") = 1 THEN CALL FStore("email")
 SELECT WHERE FILE "email"
 END SUB 
 
 
SUB MNEMAIL()
 CALL MNProgramm()
 MENU 2,0,1,"&Option","",""
 MENU 2,1,1,"aus Suchliste auswÑhlen,F7","DokKurzSuche",""
 CALL MNHilfe(3)
 END SUB 
 
SUB EMAILINT()
 REM SELECT FORM KEY knr% FILE "Adressen" INDEX codeku.adressen
 REM SELECT FORM KEY knr% FILE "email" INDEX codeku.email
 SELECT FORM FIRST FILE "email"
 END SUB 
 
  REM para% = 0 normale email aus Adressmaske
  REM para% = 1 Zugangsdaten-Email
  REM para% = 2 Werbeemail mit Werbetetxt aus supervisdatei
SUB AQRegAdr(codeku%,Nummer$,para%)
 cfile$ = FILE 
 IF NOT OPEN ("aktionen") THEN CALL DFile(2,"OFFICE\aktionen" + _fpw$)
 IF NOT OPEN (GADRDat$) THEN CALL DFile(2,"OFFICE\" + GADRDat$ + _fpw$)
 IF NOT OPEN (GAkquiDat$) THEN CALL DFile(2,"OFFICE\" + GAkquiDat$ + _fpw$)
 SELECT FIRST FILE GADRDat$ INDEX codeku.GADRDat$
 SELECT KEY codeku% FILE GADRDat$ INDEX codeku.GADRDat$
 DIM Aktionen$(300)
 FILE "AKTIONEN"
 INDEX CodeAK
 SELECT FIRST 
 a% = - 1
 WHILE NOT EOF ("AKTIONEN")
   a% = a% + 1
   Aktionen$(a%) = Bezeichnung.AKTIONEN + " (" + STR$ (CodeAK.AKTIONEN,"000000") + ")"
   SELECT NEXT 
 WEND 
 SELECT KEY 1
 Aktion$ = Bezeichnung.AKTIONEN + " (" + STR$ (CodeAK.AKTIONEN,"000000") + ")"
 DIM Mitarbeiter$(20000)
 FILE "SUPERVIS"
 INDEX CodeMA
 SELECT FIRST 
 a% = - 1
 WHILE NOT EOF ("SUPERVIS")
   a% = a% + 1
   Mitarbeiter$(a%) = Nachname.SUPERVIS + ", " + Vorname.SUPERVIS + " (" + STR$ (CodeMA.SUPERVIS,"000000") + ")"
   SELECT NEXT 
 WEND 
 SELECT KEY GMAcodema% FILE "supervis" INDEX codema.supervis
 MANachname$ = Nachname.SUPERVIS + ", " + Vorname.SUPERVIS + " (" + STR$ (CodeMA.SUPERVIS,"000000") + ")"
 datum$ = DATE$ ( TODAY ,"0d.mm.yyyy")
 Termin$ = DATE$ ( TODAY ,"0d.mm.yyyy")
 Nachname$ = Nachname.GAdrDat$
 Vorname$ = Vorname.GAdrDat$
 Stra·e$ = Stra·e.GAdrDat$
 Ort$ = PLZ.GAdrDat$ + " " + Ort.GAdrDat$
 tmpku% = CodeKU.GAdrDat$
 RNotiz$ = "sende EMAIL : "
 _ok% = 1
 GOTO dokt030920053
 
    DIM dlg AS Dialog
    DIM control AS DialogControl
 ON ERROR GOTO dokt030920051
   GOTO dokt030920052
dokt030920051: 
   CALL Fehler("Die Werte fÅr Datum oder Uhrzeit scheinen falsch zu sein!","Bitte prÅfen")
dokt030920052: 
    Superbase.Dialogs.Add("AQREGISTER")
    SET dlg = Superbase.Dialogs.AQREGISTER
    dlg.Move(0,0,354,235)
    dlg.Caption = title$
    dlg.FontName = "MS Sans Serif"
    dlg.FontSize = 8
 
    SET control = dlg.Add("DialogTextBox1","DialogTextBox")
    control.Move(5,8,40,12)
    control.MaxLength = 10
    control.TextBinding = "Datum$"
 
    SET control = dlg.Add("DialogTextBox2","DialogTextBox")
    control.Move(49,8,40,12)
    control.MaxLength = 10
    control.TextBinding = "Termin$"
 
    SET control = dlg.Add("DialogTextBox3","DialogTextBox")
    control.Move(93,8,25,12)
    control.MaxLength = 5
    control.TextBinding = "Zeit$"
 
    SET control = dlg.Add("DialogTextBox4","DialogTextBox")
    control.Move(130,8,24,12)
    control.MaxLength = 5
    control.TextBinding = "Dauer$"
    IF GADRDat$ LIKE "ADRESSEN" THEN 
      SET control = dlg.Add("DialogTextBox6","DialogTextBox")
      control.Move(185,8,40,12)
      control.MaxLength = 10
      control.TextBinding = "VTermin$"
 
      SET control = dlg.Add("DialogTextBox7","DialogTextBox")
      control.Move(235,8,25,12)
      control.MaxLength = 5
      control.TextBinding = "VZeit$"
    END IF 
    SET control = dlg.Add("DialogLabel4","DialogLabel")
    control.Move(130,22,28,11)
    control.Caption = "Dauer"
    IF GADRDat$ LIKE "ADRESSEN" THEN 
      SET control = dlg.Add("DialogLabel19","DialogLabel")
      control.Move(185,22,45,13)
      control.Caption = "Vorlagetermin"
 
      SET control = dlg.Add("DialogLabel20","DialogLabel")
      control.Move(235,22,54,13)
      control.Caption = "Vorlagezeit"
    END IF 
    SET control = dlg.Add("DialogLabel1","DialogLabel")
    control.Move(5,22,32,13)
    control.Caption = "Datum"
 
    SET control = dlg.Add("DialogLabel2","DialogLabel")
    control.Move(49,22,28,13)
    control.Caption = "Termin"
 
    SET control = dlg.Add("DialogLabel3","DialogLabel")
    control.Move(93,22,28,13)
    control.Caption = "Uhrzeit"
 
    SET control = dlg.Add("DialogLabel5","DialogLabel")
    control.Move(5,36,123,12)
    control.Caption = "Zuordnung zur Aktion"
 
    SET control = dlg.Add("DialogFrame1","DialogFrame")
    control.Move(186,44,160,81)
    control.Caption = "Adresse"
 
    SET control = dlg.Add("DialogLabel8","DialogLabel")
    control.Move(190,59,39,12)
    control.Caption = "Nachname"
 
    SET control = dlg.Add("DialogLabel14","DialogLabel")
    control.Move(230,59,116,12)
    control.NoKeyboardEquivalent = 1
    control.CaptionBinding = "Nachname$"
 
    SET control = dlg.Add("DialogLabel9","DialogLabel")
    control.Move(190,69,32,12)
    control.Caption = "Vorname"
 
    SET control = dlg.Add("DialogLabel15","DialogLabel")
    control.Move(230,69,116,12)
    control.NoKeyboardEquivalent = 1
    control.CaptionBinding = "Vorname$"
 
    SET control = dlg.Add("DialogLabel10","DialogLabel")
    control.Move(190,79,24,12)
    control.Caption = "Stra·e"
 
    SET control = dlg.Add("DialogLabel16","DialogLabel")
    control.Move(230,79,116,12)
    control.CaptionBinding = "Stra·e$"
 
    SET control = dlg.Add("DialogLabel11","DialogLabel")
    control.Move(190,89,19,12)
    control.Caption = "Ort"
 
    SET control = dlg.Add("DialogLabel17","DialogLabel")
    control.Move(230,89,116,12)
    control.CaptionBinding = "Ort$"
 
    SET control = dlg.Add("DialogCommandButton1","DialogCommandButton")
    control.Move(190,104,152,14)
    control.Caption = "Auswahl"
    control.ReturnValue = 2
 
    SET control = dlg.Add("DialogComboBox1","DialogComboBox")
    control.Move(5,46,169,83)
    control.Style = 2
    control.Sorted = 1
    control.ScrollBars = 2
    control.Bind("Aktionen$","Aktion$")
 
    SET control = dlg.Add("DialogLabel6","DialogLabel")
    control.Move(5,65,139,8)
    control.Caption = "Eintragen in den Kalender des Mitarbeiters"
 
    SET control = dlg.Add("DialogComboBox2","DialogComboBox")
    control.Move(5,76,169,90)
    control.Style = 2
    control.Sorted = 1
    control.ScrollBars = 2
    control.Bind("Mitarbeiter$","MANachname$")
 
    SET control = dlg.Add("DialogLabel7","DialogLabel")
    control.Move(5,96,139,8)
    control.Caption = "Notiz"
 
    SET control = dlg.Add("DialogTextBox5","DialogTextBox")
    control.Move(5,105,169,128)
    control.MultiLine = 1
    control.ScrollBars = 2
    control.MaxLength = 4000
    control.TextBinding = "RNotiz$"
 
    SET control = dlg.Add("DialogLabel12","DialogLabel")
    control.Move(186,133,162,29)
    control.Caption = "Wenn Sie diesen Termin nur zu Informationszwecken aufnehmen mîchten, markieren Sie bitte die Option 'Termin erledigt'."
 
    SET control = dlg.Add("DialogCheckBox1","DialogCheckBox")
    control.Move(186,165,76,12)
    control.Caption = "Termin erledigt"
    control.Bind("Terminerl$")
    control.ValueOn = "j"
    control.ValueOff = "n"
 
    SET control = dlg.Add("DialogLabel13","DialogLabel")
    control.Move(186,178,159,37)
    control.Caption = "Nach BetÑtigung der SchaltflÑche 'OK' wird der Eintrag in der Termindatei erzeugt."
 
    SET control = dlg.Add("DialogCommandButton2","DialogCommandButton")
    control.Move(186,217,78,15)
    control.Default = 1
    control.Caption = "&OK"
    control.ReturnValue = 1
 
 
 _ok% = 0
 WHILE _ok% = 0
   DIALOG "AQREGISTER",req%
   IF req% = 2 THEN 
     kunr% = ADRSuche%(0)
     IF kunr% <> 0 THEN 
       SELECT KEY kunr% FILE GAdrDat$ INDEX CodeKU.GAdrDat$
       Nachname$ = Nachname.GAdrDat$
       Vorname$ = Vorname.GAdrDat$
       Stra·e$ = Stra·e.GAdrDat$
       Ort$ = PLZ.GAdrDat$ + " " + Ort.GAdrDat$
       tmpku% = CodeKU.GAdrDat$
     END IF 
   END IF 
   IF req% = 0 THEN _ok% = 2
   IF req% = 1 THEN _ok% = 1
 WEND 
 REMOVE DIALOG "AQREGISTER"
dokt030920053: 
 IF _ok% = 1 THEN 
   IF para% = 2 THEN 
     REM 21022007 - Werbeemail
     REM anzeige was in wemail vorhanden ist, danach gehts weiter
     FILE "wemail"
     INDEX codekey.wemail
     SELECT FIRST FILE "wemail" INDEX codekey.wemail
     DIM wemail$( RECCOUNT ("wemail"))
     a% = 0
     WHILE NOT EOF ("wemail")
       ok% = - 1
       IF ok% = - 1 THEN 
         wemail$(a%) = Beschreibung.wemail + "/" + name.wemail + "/" + DATE$ (Datum.wemail,"0d.mm.yyyy") + SPACE$ (100) + STR$ (Codekey.wemail,"0000000")
         a% = a% + 1
       END IF 
       SELECT NEXT FILE "wemail" INDEX codekey.wemail
     WEND 
     DIM Auswahl1$(1)
     Auswahl$ = wemail$(0)
     Auswahl1$(0) = Auswahl$
     codekey% = 0
     GWemailAbr% = - 1
     CREATE DIALOG "PREISLIS",0,0,500,364,"Werbe-Email-Vorlage","MS Sans Serif",8
     ADD DIALOG "PREISLIS",4,0,0,499,340,0," Auswahl Werbe-Email-Vorlage"
     ADD DIALOG "PREISLIS",7,5,14,489,325,2,2,wemail$,Auswahl1$," "
     ADD DIALOG "PREISLIS",1,17,345,55,16,1,"&OK",1,1
     ADD DIALOG "PREISLIS",1,77,345,55,16,0,"&Abbrechen",0,0
     DIALOG "PREISLIS",req%
     REMOVE DIALOG "PREISLIS"
     IF req% = 1 THEN 
       codekey% = VAL ( RIGHT$ (Auswahl1$(0),8))
       IF codekey% > 0 THEN 
         SELECT FIRST FILE "wemail" INDEX codekey.wemail
         SELECT KEY codekey% FILE "wemail" INDEX codekey.wemail
       END IF 
     END IF 
     IF codekey% = 0 OR req% = 0 THEN 
       CALL Fehler("Auswahl abgebrochen","")
       GWemailAbr% = 0
       GOTO we210220072
     END IF 
 
     REM ****************
   END IF 
   FILE GAkquiDat$
   BLANK FILE GAkquiDat$
   IF para% = 2 THEN 
     REM 21022007 - Werbeemail
     REM anzeige was in wemail vorhanden ist, danach gehts weiter
     IF codekey% > 0 AND req% = 1 THEN 
       REM copyrecord
       a% = CopyRecord%("wemail","Akquise")
       
     END IF 
   END IF 
   cuaq% = SER (GAkquiDat$,1)
   codeaq.GAkquiDat$ = cuaq%
   codeKU.GAkquiDat$ = tmpku%
   CodeAK.GAkquiDat$ = VAL ( MID$ (Aktion$, LEN (Aktion$) - 6,6))
   CodeMA.GAkquiDat$ = VAL ( MID$ (MANachname$, LEN (MANachname$) - 6,6))
   codema1% = VAL ( MID$ (MANachname$, LEN (MANachname$) - 6,6))
   SELECT KEY tmpku% FILE GAdrDat$ INDEX CodeKU.GAdrDat$
   nachname.GAkquiDat$ = nachname.GAdrDat$
   Wertung.GAkquiDat$ = 0
   Datum.GAkquiDat$ = Datum$
   Uhrzeit.GAkquiDat$ = zeit$
   Dauer.GAkquiDat$ = VAL (dauer$)
   CodeDOK.GAkquiDat$ = 0
   ErDatum.GAkquiDat$ = VTermin$
   ErZeit.GAkquiDat$ = VZeit$
   REM REQUEST "Soll der Termin erledigt werden?","",130,req%
   IF req% = 1 THEN 
     erledigt_Termin.GAkquiDat$ = "n"
   END IF 
   SELECT KEY codema.GAkquiDat$ LOCK FILE "supervis" INDEX codema.supervis
   Bearbeiter.GAkquiDat$ = nachname.supervis
   IF _projekt$ LIKE "PROVIS" OR _projekt$ LIKE "IMMAK" THEN 
     AnzTermine.supervis = AnzTermine.supervis + 1
     IF Terminerl$ LIKE "j" THEN 
       AnzTermineErl.supervis = AnzTermineErl.supervis + 1
     ELSE 
       AnzTermineUnErl.supervis = AnzTermineUnErl.supervis + 1
     END IF 
   END IF 
   STORE FILE "supervis"
   UNLOCK CURRENT FILE "Supervis"
   notiz.GAkquiDat$ = rnotiz$
   termin.GAkquiDat$ = Termin$
   erledigt_Termin.GAkquiDat$ = Terminerl$
   IF _projekt$ LIKE "PROVIS" OR _projekt$ LIKE "IMMAK" THEN 
     TerminNr.GAkquiDat$ = AnzTermine.supervis
   END IF 
   REM 01032001
   GErledTermin$ = Terminerl$
   emailto.akquise = Nummer$
   REM normale email aus Adressmaske
   IF para% < 1 THEN 
     eMAILtEXT.akquise = Briefanrede.adressen + CHR$ (13) + CHR$ (10) + CHR$ (13) + CHR$ (10) + CHR$ (13) + CHR$ (10) + CHR$ (13) + CHR$ (10)
     eMAILtEXT1.akquise = EMAILText1.supervis + CHR$ (13) + CHR$ (10) + CHR$ (13) + CHR$ (10)
     eMAILtEXT1.akquise = eMAILtEXT1.akquise + EMAILText2.supervis
   END IF 
   REM Zugangsdaten email
   IF para% = 1 THEN 
     IF version.adressen LIKE "CBFC*" THEN 
       EMAILBETREFF.akquise = "CODieBOARD#finance-center Update"
     ELSE 
       EMAILBETREFF.akquise = "CODie-SmartPROVIS Update"
     END IF 
     t1t$ = Briefanrede.adressen + CHR$ (13) + CHR$ (10) + CHR$ (13) + CHR$ (10)
     IF version.adressen LIKE "CBFC*" THEN 
       t1t$ = t1t$ + "anbei Åbersenden wir Ihnen die Zugangsdaten fÅr Ihr Update des Programmes CODieBOARD#finance-center" + CHR$ (13) + CHR$ (10) + CHR$ (13) + CHR$ (10)
     ELSE 
       t1t$ = t1t$ + "anbei Åbersenden wir Ihnen die Zugangsdaten fÅr Ihr Update des Programmes SmartPROVIS" + CHR$ (13) + CHR$ (10) + CHR$ (13) + CHR$ (10)
     END IF 
     t1t$ = t1t$ + "Internetadresse: http://www.codie.com" + CHR$ (13) + CHR$ (10)
     t1t$ = t1t$ + "Benutzername: " + Internetname.adressen + CHR$ (13) + CHR$ (10)
     t1t$ = t1t$ + "Passwort: " + Internetpasswo.adressen + CHR$ (13) + CHR$ (10) + CHR$ (13) + CHR$ (10)
     IF version.adressen LIKE "CBFC*" THEN 
       t1t$ = t1t$ + "Bitte denken Sie an eine Datensicherung der gesamten CBFC Datenbank mittel des MS Enterprisemanger oder des MS Managementstudios!!!!!!!!" + CHR$ (13) + CHR$ (10) + CHR$ (13) + CHR$ (10)
     ELSE 
       t1t$ = t1t$ + "Bitte denken an eine Datensicherung des gesamten CODie-Ordners!!!!!!!!!" + CHR$ (13) + CHR$ (10) + CHR$ (13) + CHR$ (10)
     END IF 
     t1t$ = t1t$ + "Bitte lesen Sie den Updatetext und informieren auch Ihre Mitarbeiter Åber die kÅnftigen énderungen im Programm." + CHR$ (13) + CHR$ (10)
     REM t1t$ = t1t$ + "Vor der Installation fÅhren Sie bitte eine komplette Datensicherung durch, die auch die Sicherung der Dokumente beinhalten sollte." + CHR$ (13) + CHR$ (10)
     t1t$ = t1t$ + "Denken Sie daran, dass wÑhrend der Installation und Datenanpassung kein anderer Nutzer das System geîffnet haben darf. Gehen Sie in der vom System vorgegebenen Reihenfolge vor." + CHR$ (13) + CHR$ (10)
     t1t$ = t1t$ + "Bitte prÅfen Sie, ob Sie den Update-Beitrag Brutto fÅr das 2.Halbjahr 2006 Åberwiesen haben, wenn nicht, bitten wir Sie hiermit um Begleichung des Betrages." + CHR$ (13) + CHR$ (10)
     t1t$ = t1t$ + "Kunden mit Online Servicevertrag (Updateinstallation durch CODie) vereinbaren bitte einen Installationstermin mit Herrn Bargfried (bei der Installation darf kein Mitarbeiter mit dem System arbeiten)" + CHR$ (13) + CHR$ (10)
     t1t$ = t1t$ + "Bei technischen Fragen zur ASP Version wenden Sie sich bitte an die Firma Maklersoftware.com oder an die Smea GmbH. " + CHR$ (13) + CHR$ (10) + CHR$ (13) + CHR$ (10)
     t1t$ = t1t$ + "Bei Fragen und WÅnschen rufen Sie uns bitte an! " + CHR$ (13) + CHR$ (10) + CHR$ (13) + CHR$ (10)
     t1t$ = t1t$ + "Mit freundlichen GrÅ·en verbleibt" + CHR$ (13) + CHR$ (10) + CHR$ (13) + CHR$ (10)
     t1t$ = t1t$ + "Ihr CODie Team" + CHR$ (13) + CHR$ (10) + CHR$ (13) + CHR$ (10) + CHR$ (13) + CHR$ (10)
 
     eMAILtEXT.akquise = t1t$
     eMAILtEXT1.akquise = EMAILText1.supervis + CHR$ (13) + CHR$ (10) + CHR$ (13) + CHR$ (10)
     eMAILtEXT1.akquise = eMAILtEXT1.akquise + EMAILText2.supervis
   END IF 
   REM Werbeemail
   IF para% = 2 THEN 
     atest2$ = Postanschrift.adressen + + CHR$ (13) + CHR$ (10) + CHR$ (13) + CHR$ (10) + Briefanrede.adressen + CHR$ (13) + CHR$ (10) + CHR$ (13) + CHR$ (10) + eMAILtEXT.akquise
     eMAILtEXT.akquise = atest2$
     eMAILtEXT1.akquise = EMAILText1.supervis + CHR$ (13) + CHR$ (10) + CHR$ (13) + CHR$ (10)
     eMAILtEXT1.akquise = eMAILtEXT1.akquise + EMAILText2.supervis
     REM t1t$ = Werbeemail.supervis + CHR$ (13) + CHR$ (10)
     REM eMAILtEXT.akquise = Briefanrede.adressen + CHR$ (13) + CHR$ (10) + CHR$ (13) + CHR$ (10)
     REM eMAILtEXT.akquise = eMAILtEXT.akquise + t1t$
     REM eMAILtEXT1.akquise = EMAILText1.supervis + CHR$ (13) + CHR$ (10) + CHR$ (13) + CHR$ (10)
     REM eMAILtEXT1.akquise = eMAILtEXT1.akquise + EMAILText2.supervis
   END IF 
   REM emailbetreff.akquise = Betreff.mail
   REM emailtext.akquise = nachricht.mail
   REM emailcc.akquise = emailcc.mail
   REM emailbcc.akquise = emailbcc.mail
   CALL FStore(GAkquiDat$)
 END IF 
we210220072: 
 FILE cfile$
 ON ERROR GOTO ErrorHandler
 MOUSE ON 
 END SUB 
 



  REM para% = 0 normale email aus Adressmaske
  REM para% = 1 Zugangsdaten-Email
  REM para% = 2 Werbeemail mit Werbetetxt aus supervisdatei
SUB AQRegAdrold(codeku%,Nummer$,para%)
 cfile$ = FILE 
 IF NOT OPEN ("aktionen") THEN CALL DFile(2,"OFFICE\aktionen" + _fpw$)
 IF NOT OPEN (GADRDat$) THEN CALL DFile(2,"OFFICE\" + GADRDat$ + _fpw$)
 IF NOT OPEN (GAkquiDat$) THEN CALL DFile(2,"OFFICE\" + GAkquiDat$ + _fpw$)
 SELECT FIRST FILE GADRDat$ INDEX codeku.GADRDat$
 SELECT KEY codeku% FILE GADRDat$ INDEX codeku.GADRDat$
 DIM Aktionen$(300)
 FILE "AKTIONEN"
 INDEX CodeAK
 SELECT FIRST 
 a% = - 1
 WHILE NOT EOF ("AKTIONEN")
   a% = a% + 1
   Aktionen$(a%) = Bezeichnung.AKTIONEN + " (" + STR$ (CodeAK.AKTIONEN,"000000") + ")"
   SELECT NEXT 
 WEND 
 SELECT KEY 1
 Aktion$ = Bezeichnung.AKTIONEN + " (" + STR$ (CodeAK.AKTIONEN,"000000") + ")"
 DIM Mitarbeiter$(20000)
 FILE "SUPERVIS"
 INDEX CodeMA
 SELECT FIRST 
 a% = - 1
 WHILE NOT EOF ("SUPERVIS")
   a% = a% + 1
   Mitarbeiter$(a%) = Nachname.SUPERVIS + ", " + Vorname.SUPERVIS + " (" + STR$ (CodeMA.SUPERVIS,"000000") + ")"
   SELECT NEXT 
 WEND 
 SELECT KEY GMAcodema% FILE "supervis" INDEX codema.supervis
 MANachname$ = Nachname.SUPERVIS + ", " + Vorname.SUPERVIS + " (" + STR$ (CodeMA.SUPERVIS,"000000") + ")"
 datum$ = DATE$ ( TODAY ,"0d.mm.yyyy")
 Termin$ = DATE$ ( TODAY ,"0d.mm.yyyy")
 Nachname$ = Nachname.GAdrDat$
 Vorname$ = Vorname.GAdrDat$
 Stra·e$ = Stra·e.GAdrDat$
 Ort$ = PLZ.GAdrDat$ + " " + Ort.GAdrDat$
 tmpku% = CodeKU.GAdrDat$
 RNotiz$ = "sende EMAIL : "
 _ok% = 1
 GOTO dokt030920053
 
    DIM dlg AS Dialog
    DIM control AS DialogControl
 ON ERROR GOTO dokt030920051
   GOTO dokt030920052
dokt030920051: 
   CALL Fehler("Die Werte fÅr Datum oder Uhrzeit scheinen falsch zu sein!","Bitte prÅfen")
dokt030920052: 
    Superbase.Dialogs.Add("AQREGISTER")
    SET dlg = Superbase.Dialogs.AQREGISTER
    dlg.Move(0,0,354,235)
    dlg.Caption = title$
    dlg.FontName = "MS Sans Serif"
    dlg.FontSize = 8
 
    SET control = dlg.Add("DialogTextBox1","DialogTextBox")
    control.Move(5,8,40,12)
    control.MaxLength = 10
    control.TextBinding = "Datum$"
 
    SET control = dlg.Add("DialogTextBox2","DialogTextBox")
    control.Move(49,8,40,12)
    control.MaxLength = 10
    control.TextBinding = "Termin$"
 
    SET control = dlg.Add("DialogTextBox3","DialogTextBox")
    control.Move(93,8,25,12)
    control.MaxLength = 5
    control.TextBinding = "Zeit$"
 
    SET control = dlg.Add("DialogTextBox4","DialogTextBox")
    control.Move(130,8,24,12)
    control.MaxLength = 5
    control.TextBinding = "Dauer$"
    IF GADRDat$ LIKE "ADRESSEN" THEN 
      SET control = dlg.Add("DialogTextBox6","DialogTextBox")
      control.Move(185,8,40,12)
      control.MaxLength = 10
      control.TextBinding = "VTermin$"
 
      SET control = dlg.Add("DialogTextBox7","DialogTextBox")
      control.Move(235,8,25,12)
      control.MaxLength = 5
      control.TextBinding = "VZeit$"
    END IF 
    SET control = dlg.Add("DialogLabel4","DialogLabel")
    control.Move(130,22,28,11)
    control.Caption = "Dauer"
    IF GADRDat$ LIKE "ADRESSEN" THEN 
      SET control = dlg.Add("DialogLabel19","DialogLabel")
      control.Move(185,22,45,13)
      control.Caption = "Vorlagetermin"
 
      SET control = dlg.Add("DialogLabel20","DialogLabel")
      control.Move(235,22,54,13)
      control.Caption = "Vorlagezeit"
    END IF 
    SET control = dlg.Add("DialogLabel1","DialogLabel")
    control.Move(5,22,32,13)
    control.Caption = "Datum"
 
    SET control = dlg.Add("DialogLabel2","DialogLabel")
    control.Move(49,22,28,13)
    control.Caption = "Termin"
 
    SET control = dlg.Add("DialogLabel3","DialogLabel")
    control.Move(93,22,28,13)
    control.Caption = "Uhrzeit"
 
    SET control = dlg.Add("DialogLabel5","DialogLabel")
    control.Move(5,36,123,12)
    control.Caption = "Zuordnung zur Aktion"
 
    SET control = dlg.Add("DialogFrame1","DialogFrame")
    control.Move(186,44,160,81)
    control.Caption = "Adresse"
 
    SET control = dlg.Add("DialogLabel8","DialogLabel")
    control.Move(190,59,39,12)
    control.Caption = "Nachname"
 
    SET control = dlg.Add("DialogLabel14","DialogLabel")
    control.Move(230,59,116,12)
    control.NoKeyboardEquivalent = 1
    control.CaptionBinding = "Nachname$"
 
    SET control = dlg.Add("DialogLabel9","DialogLabel")
    control.Move(190,69,32,12)
    control.Caption = "Vorname"
 
    SET control = dlg.Add("DialogLabel15","DialogLabel")
    control.Move(230,69,116,12)
    control.NoKeyboardEquivalent = 1
    control.CaptionBinding = "Vorname$"
 
    SET control = dlg.Add("DialogLabel10","DialogLabel")
    control.Move(190,79,24,12)
    control.Caption = "Stra·e"
 
    SET control = dlg.Add("DialogLabel16","DialogLabel")
    control.Move(230,79,116,12)
    control.CaptionBinding = "Stra·e$"
 
    SET control = dlg.Add("DialogLabel11","DialogLabel")
    control.Move(190,89,19,12)
    control.Caption = "Ort"
 
    SET control = dlg.Add("DialogLabel17","DialogLabel")
    control.Move(230,89,116,12)
    control.CaptionBinding = "Ort$"
 
    SET control = dlg.Add("DialogCommandButton1","DialogCommandButton")
    control.Move(190,104,152,14)
    control.Caption = "Auswahl"
    control.ReturnValue = 2
 
    SET control = dlg.Add("DialogComboBox1","DialogComboBox")
    control.Move(5,46,169,83)
    control.Style = 2
    control.Sorted = 1
    control.ScrollBars = 2
    control.Bind("Aktionen$","Aktion$")
 
    SET control = dlg.Add("DialogLabel6","DialogLabel")
    control.Move(5,65,139,8)
    control.Caption = "Eintragen in den Kalender des Mitarbeiters"
 
    SET control = dlg.Add("DialogComboBox2","DialogComboBox")
    control.Move(5,76,169,90)
    control.Style = 2
    control.Sorted = 1
    control.ScrollBars = 2
    control.Bind("Mitarbeiter$","MANachname$")
 
    SET control = dlg.Add("DialogLabel7","DialogLabel")
    control.Move(5,96,139,8)
    control.Caption = "Notiz"
 
    SET control = dlg.Add("DialogTextBox5","DialogTextBox")
    control.Move(5,105,169,128)
    control.MultiLine = 1
    control.ScrollBars = 2
    control.MaxLength = 4000
    control.TextBinding = "RNotiz$"
 
    SET control = dlg.Add("DialogLabel12","DialogLabel")
    control.Move(186,133,162,29)
    control.Caption = "Wenn Sie diesen Termin nur zu Informationszwecken aufnehmen mîchten, markieren Sie bitte die Option 'Termin erledigt'."
 
    SET control = dlg.Add("DialogCheckBox1","DialogCheckBox")
    control.Move(186,165,76,12)
    control.Caption = "Termin erledigt"
    control.Bind("Terminerl$")
    control.ValueOn = "j"
    control.ValueOff = "n"
 
    SET control = dlg.Add("DialogLabel13","DialogLabel")
    control.Move(186,178,159,37)
    control.Caption = "Nach BetÑtigung der SchaltflÑche 'OK' wird der Eintrag in der Termindatei erzeugt."
 
    SET control = dlg.Add("DialogCommandButton2","DialogCommandButton")
    control.Move(186,217,78,15)
    control.Default = 1
    control.Caption = "&OK"
    control.ReturnValue = 1
 
 
 _ok% = 0
 WHILE _ok% = 0
   DIALOG "AQREGISTER",req%
   IF req% = 2 THEN 
     kunr% = ADRSuche%(0)
     IF kunr% <> 0 THEN 
       SELECT KEY kunr% FILE GAdrDat$ INDEX CodeKU.GAdrDat$
       Nachname$ = Nachname.GAdrDat$
       Vorname$ = Vorname.GAdrDat$
       Stra·e$ = Stra·e.GAdrDat$
       Ort$ = PLZ.GAdrDat$ + " " + Ort.GAdrDat$
       tmpku% = CodeKU.GAdrDat$
     END IF 
   END IF 
   IF req% = 0 THEN _ok% = 2
   IF req% = 1 THEN _ok% = 1
 WEND 
 REMOVE DIALOG "AQREGISTER"
dokt030920053: 
 IF _ok% = 1 THEN 
   FILE GAkquiDat$
   BLANK FILE GAkquiDat$
   cuaq% = SER (GAkquiDat$,1)
   codeaq.GAkquiDat$ = cuaq%
   codeKU.GAkquiDat$ = tmpku%
   CodeAK.GAkquiDat$ = VAL ( MID$ (Aktion$, LEN (Aktion$) - 6,6))
   CodeMA.GAkquiDat$ = VAL ( MID$ (MANachname$, LEN (MANachname$) - 6,6))
   codema1% = VAL ( MID$ (MANachname$, LEN (MANachname$) - 6,6))
   SELECT KEY tmpku% FILE GAdrDat$ INDEX CodeKU.GAdrDat$
   nachname.GAkquiDat$ = nachname.GAdrDat$
   Wertung.GAkquiDat$ = 0
   Datum.GAkquiDat$ = Datum$
   Uhrzeit.GAkquiDat$ = zeit$
   Dauer.GAkquiDat$ = VAL (dauer$)
   CodeDOK.GAkquiDat$ = 0
   ErDatum.GAkquiDat$ = VTermin$
   ErZeit.GAkquiDat$ = VZeit$
   SELECT KEY codema.GAkquiDat$ LOCK FILE "supervis" INDEX codema.supervis
   Bearbeiter.GAkquiDat$ = nachname.supervis
   IF _projekt$ LIKE "PROVIS" OR _projekt$ LIKE "IMMAK" THEN 
     AnzTermine.supervis = AnzTermine.supervis + 1
     IF Terminerl$ LIKE "j" THEN 
       AnzTermineErl.supervis = AnzTermineErl.supervis + 1
     ELSE 
       AnzTermineUnErl.supervis = AnzTermineUnErl.supervis + 1
     END IF 
   END IF 
   STORE FILE "supervis"
   UNLOCK CURRENT FILE "Supervis"
   IF PROJECTJN$ = "TRUE" THEN 
     codepr.GAkquiDat$ = codeprdok%
     projekt.GAkquiDat$ = projektdok$
     codeprdok% = 0
     projektdok$ = ""
   END IF 
   notiz.GAkquiDat$ = rnotiz$
   termin.GAkquiDat$ = Termin$
   erledigt_Termin.GAkquiDat$ = Terminerl$
   IF _projekt$ LIKE "PROVIS" OR _projekt$ LIKE "IMMAK" THEN 
     TerminNr.GAkquiDat$ = AnzTermine.supervis
   END IF 
   REM 01032001
   GErledTermin$ = Terminerl$
   emailto.akquise = Nummer$
   REM normale email aus Adressmaske
   IF para% < 1 THEN 
     eMAILtEXT.akquise = Briefanrede.adressen + CHR$ (13) + CHR$ (10) + CHR$ (13) + CHR$ (10) + CHR$ (13) + CHR$ (10) + CHR$ (13) + CHR$ (10)
     eMAILtEXT1.akquise = EMAILText1.supervis + CHR$ (13) + CHR$ (10) + CHR$ (13) + CHR$ (10)
     eMAILtEXT1.akquise = eMAILtEXT1.akquise + EMAILText2.supervis
   END IF 
   REM Zugangsdaten email
   IF para% = 1 THEN 
     EMAILBETREFF.akquise = "CODie-SmartPROVIS Update"
     t1t$ = Briefanrede.adressen + CHR$ (13) + CHR$ (10) + CHR$ (13) + CHR$ (10)
     t1t$ = t1t$ + "anbei Åbersenden wir Ihnen die Zugangsdaten fÅr Ihr Update des Programmes SmartPROVIS" + CHR$ (13) + CHR$ (10) + CHR$ (13) + CHR$ (10)
     t1t$ = t1t$ + "Internetadresse: http://www.codie.com" + CHR$ (13) + CHR$ (10)
     t1t$ = t1t$ + "Benutzername: " + Internetname.adressen + CHR$ (13) + CHR$ (10)
     t1t$ = t1t$ + "Passwort: " + Internetpasswo.adressen + CHR$ (13) + CHR$ (10) + CHR$ (13) + CHR$ (10)
     t1t$ = t1t$ + "Bitte denken an eine komplette Datensicherung des gesamten CODie-Ordners !!!!!!!!!" + CHR$ (13) + CHR$ (10) + CHR$ (13) + CHR$ (10)
 
     t1t$ = t1t$ + "Bitte lesen Sie den Updatetext und informieren auch Ihre Mitarbeiter Åber die kÅnftigen énderungen im Programm." + CHR$ (13) + CHR$ (10)
     t1t$ = t1t$ + "Vor der Installation fÅhren Sie bitte eine komplette Datensicherung durch, die auch die Sicherung der Dokumente beinhalten sollte." + CHR$ (13) + CHR$ (10)
     t1t$ = t1t$ + "Installation kein anderer Nutzer das System geîffnet haben darf. Gehen Sie in der vom System vorgegebenen Reihenfolge vor." + CHR$ (13) + CHR$ (10)
     t1t$ = t1t$ + "Bitte prÅfen Sie, ob Sie den Update-Beitrag Brutto fÅr das 1.Halbjahr 2006 Åberwiesen haben, wenn nicht, bitten wir Sie hiermit um Begleichung des Betrages." + CHR$ (13) + CHR$ (10)
     t1t$ = t1t$ + "Kunden mit Online Servicevertrag (Updateinstallation durch CODie) vereinbaren bitte einen Installationstermin mit Herrn Bargfried (bei der Installation darf kein Mitarbeiter mit dem System arbeiten)" + CHR$ (13) + CHR$ (10)
     t1t$ = t1t$ + "Bei technischen Fragen zur ASP Version wenden Sie sich bitte an die Firma Maklersoftware.com oder an die Smea GmbH. " + CHR$ (13) + CHR$ (10) + CHR$ (13) + CHR$ (10)
     t1t$ = t1t$ + "Bei Fragen und WÅnschen rufen Sie uns bitte an! " + CHR$ (13) + CHR$ (10) + CHR$ (13) + CHR$ (10)
     t1t$ = t1t$ + "Mit freundlichen GrÅ·en verbleibt" + CHR$ (13) + CHR$ (10) + CHR$ (13) + CHR$ (10)
     t1t$ = t1t$ + "das CODie Team" + CHR$ (13) + CHR$ (10) + CHR$ (13) + CHR$ (10) + CHR$ (13) + CHR$ (10)
 
     eMAILtEXT.akquise = t1t$
     eMAILtEXT1.akquise = EMAILText1.supervis + CHR$ (13) + CHR$ (10) + CHR$ (13) + CHR$ (10)
     eMAILtEXT1.akquise = eMAILtEXT1.akquise + EMAILText2.supervis
   END IF 
   REM Werbeemail
   IF para% = 2 THEN 
     REM 21022007 - Werbeemail
     REM anzeige was in wemail vorhanden ist, danach gehts weiter
     FILE "wemail"
     INDEX codekey.wemail
     SELECT FIRST FILE "wemail" INDEX codekey.wemail
     DIM wemail$( RECCOUNT ("wemail"))
     a% = 0
     WHILE NOT EOF ("wemail")
       ok% = - 1
       IF ok% = - 1 THEN 
         wemail$(a%) = Beschreibung.wemail + "/" + name.wemail + "/" + DATE$ (Datum.wemail,"0d.mm.yyyy") + SPACE$ (100) + STR$ (Codekey.wemail,"0000000")
         a% = a% + 1
       END IF 
       SELECT NEXT FILE "wemail" INDEX codekey.wemail
     WEND 
     DIM Auswahl1$(1)
     Auswahl$ = wemail$(0)
     Auswahl1$(0) = Auswahl$
     codekey% = 0
     CREATE DIALOG "PREISLIS",0,0,500,364,"Werbe-Email-Vorlage","MS Sans Serif",8
     ADD DIALOG "PREISLIS",4,0,0,499,340,0," Auswahl Werbe-Email-Vorlage"
     ADD DIALOG "PREISLIS",7,5,14,489,325,2,2,wemail$,Auswahl1$," "
     ADD DIALOG "PREISLIS",1,17,345,55,16,1,"&OK",1,1
     ADD DIALOG "PREISLIS",1,77,345,55,16,0,"&Abbrechen",0,0
     DIALOG "PREISLIS",req%
     REMOVE DIALOG "PREISLIS"
     IF req% = 1 THEN 
       codekey% = VAL ( RIGHT$ (Auswahl1$(0),8))
       IF codekey% > 0 THEN 
         SELECT FIRST FILE "wemail" INDEX codekey.wemail
         SELECT KEY codekey% FILE "wemail" INDEX codekey.wemail
       END IF 
     END IF 
     IF codekey% = 0 OR req% = 0 THEN 
       CALL Fehler("Auswahl abgebrochen","")
       GOTO we210220072
     END IF 
 
     REM ****************
   END IF 
 REM emailbetreff.akquise = Betreff.mail
   REM emailtext.akquise = nachricht.mail
   REM emailcc.akquise = emailcc.mail
   REM emailbcc.akquise = emailbcc.mail
   CALL FStore(GAkquiDat$)
 END IF 
 FILE cfile$
 ON ERROR GOTO ErrorHandler
 MOUSE ON 
 END SUB 

