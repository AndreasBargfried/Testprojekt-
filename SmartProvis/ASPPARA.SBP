SBP
 
ÿÿPPCSPARA()
 ÿ’ÿÿ

ÿÿmain()
'CALL Send()

 ÿ’ÿÿ
 

ÿÿWriteTo(datei$)
 'verzweigt je nach PPCS-Status und Workstation-Nummer in WriteToLoad (PPCS) oder WriteToSend (lokale Arbeit) 
ÿ¡GFilialeNow%ÿÿ1ÿpÿ’ÿÿ
ÿ¡jaDebug%ÿÿ1ÿpÿƒFehler("WriteTo():",datei$)
oldErrorLabel$ÿSuperbase.ErrorTrapLabel
cfile$ÿÿ™
ÿ™datei$

ÿƒGetFileInfo(datei$)
typ$ÿjaFileTyp$

ÿ¡jaFileTyp$ÿ""ÿjaFileTyp$ÿ"I"ÿpÿ’ÿÿ'kein am Abgleich beteiligtes File 

code$ÿjaFileCode$ÿ"."ÿdatei$
'CodeServer muá immer gesetzt werden, da hier nicht zwischen 
'neuen und ge„nderten Daten unterschieden werden kann

ÿ¡GPPCS$ÿ"TRUE"ÿp
toLoad%ÿ0
ÿÉÿæjaFileTyp$

ÿæ"A","C"

'RecStatus-Felder setzen
wks$ÿ"Workstation."ÿdatei$
ÿÊÿ£code$$
ÿÉÿYÿáÿ™datei$ÿ£code$$
 
recfield$ÿ"rec0."ÿdatei$
recfield$$ÿwks$$
a%ÿwks$$
ÿ›i%ÿ1ÿq19
recfield$ÿ"rec"ÿÿ(i%,"z")ÿ"."ÿdatei$
recfield$$ÿwks$$' jetzt Dirty !
ÿ±i%

'das eigene RecStatus-Feld als abgeglichen markieren, da ein WriteToLoad-Aufruf folgt
recfield$ÿjaRecField$ÿ"."ÿdatei$
recfield$$ÿ10000000ÿwks$$
 
ÿÌÿ™datei$
ÿïÿYÿ™datei$
 
ÿæ"Z","Y"
 
'Dirty-Z„hler inkrementieren                
dirty$ÿ"rec0."ÿdatei$
ÿÊÿ£code$$
ÿÉÿYÿáÿ™datei$ÿ£code$$
dirty$$ÿdirty$$ÿ1
ÿÌÿ™datei$
ÿïÿYÿ™datei$
ÿ’ÿæ

ÿ¡Workstation%ÿ0ÿ((jaFileTyp$ÿ"A")ÿ(jaFileTyp$ÿ"Y")ÿ(jaFileTyp$ÿ"C"))ÿp
ÿ¡WriteToLoad%(datei$,0)ÿÿ1ÿp' die "0" : kein Un-Dirty in WriteToLoad n”tig 

ÿ’ÿ¡
ÿ’ÿ¡

ÿ^'Offline 
ÿ¡Workstation%ÿ0ÿp'(sis)      

'Filiale offline ==> WriteToSend ?: nur, wenn Typ A oder Y (auch sis)
ÿ¡jaFileTyp$ÿ"A"ÿjaFileTyp$ÿ"Y"ÿp
ÿ¡WriteToSend%(datei$)ÿÿ1ÿp
ÿ’ÿ¡
ÿ’ÿ¡

ÿ’ÿ¡
ÿ’ÿ¡
 
WriteToEnde: 
ÿ™cfile$
Superbase.ErrorTrapLabelÿoldErrorLabel$
 ÿ’ÿÿ
 '***********************************************************************************************     
 

ÿÿWriteToSend%(datei$)
 'bertr„gt Žnderungen im aktuellen Datensatz von _datei$ in die zugeh”rige *Send - Datei
 'Rckgabe von -1, falls erfolgreich
 'Vorgehen:
 'Testen, ob der modifizierte/neue Datensatz schon in der Send-Datei ex.
 'wenn ja ==> berschreiben, sonst neu erzeugen und kopieren    
 '
 'Voraussetzung: globale Variablen mit File-Information wurden ber GetFileInfo() gelesen
 '(das macht WriteTo())
 oldErrorLabel$ÿSuperbase.ErrorTrapLabel
 WriteToSend%ÿ0
 ÿ³ÿ_ÿwErrorHandler
 datei$ÿÿ>(datei$)
 ÿ¡jaDebug%ÿÿ1ÿpÿƒFehler("WriteToSend:",datei$)

 'Send-Variablen 
 codefield$ÿjaFileCode$ÿ"."
 typ$ÿjaFileTyp$
 sendfile$ÿjaFilePrefix$ÿ"Send"
 
 'werden in bzw. nach der select-Anweisung definiert 
sendTState$ÿ"TSTate."ÿsendfile$
localcode$ÿcodefield$ÿdatei$
sendcode$ÿcodefield$ÿsendfile$
codeserver$ÿ"CodeServer."ÿsendfile$

ÿ¡ÿOÿ´(sendfile$)ÿpÿƒDFile(2,"ABGLEICH\SEND\"ÿsendfile$ÿ";paris")

 'befindet sich der Datensatz schon in dem Send-File (sendfile$)  
 ÿ¡ÿOÿJ(localcode$$,sendcode$$)ÿp
ÿÿ™sendfile$
ÿ¡CopyRecord%(datei$,sendfile$)ÿÿ1ÿpÿƒFehler("Fehler in CopyRecord",ÿ(ÿ&,"z")ÿ": "ÿÿ((ÿ&))

'damit beim Send()-Vorgang automatisch ber CopyRecord() die Dirty-Bits
'fr die anderen Pfad-Teilnehmer gesetzt werden: 
'(die verdammte Null gesondert behandeln)
wks$ÿ"Workstation."ÿdatei$
recfield$ÿ"rec0."ÿsendfile$
recfield$$ÿwks$$
ÿ›i%ÿ1ÿq19
recfield$ÿ"rec"ÿÿ(i%,"z")ÿ"."ÿsendfile$'nicht abgeglichen
recfield$$ÿwks$$
ÿ±i%
recfield$ÿjaRecField$ÿ"."ÿsendfile$'das eigene Rec-Field als abgeglichen markieren
recfield$$ÿ10000000ÿwks$$
sendTState$$ÿ"1"'als nicht abgeglichen markieren

ÿÌÿ™sendfile$
 ÿ^
'Datensatz ex. bereits ==> berschreiben
ÿÉÿ`ÿ™sendfile$ÿ£sendcode$$
ÿÉÿ¥localcode$$ÿáÿ™sendfile$ÿ£sendcode$$
ÿ¡sendcode$$ÿlocalcode$$ÿp
ÿwWriteToSendError
ÿ’ÿ¡
 
ÿ¡CopyRecord%(datei$,sendfile$)ÿÿ1ÿpÿwWriteToSendError
wks$ÿ"Workstation."ÿdatei$
recfield$ÿ"rec0."ÿsendfile$
recfield$$ÿwks$$
ÿ›i%ÿ1ÿq19
recfield$ÿ"rec"ÿÿ(i%,"z")ÿ"."ÿsendfile$'nicht abgeglichen
recfield$$ÿwks$$
ÿ±i%
recfield$ÿjaRecField$ÿ"."ÿsendfile$'das eigene Rec-Field als abgeglichen markieren    
recfield$$ÿ10000000ÿwks$$
sendTState$$ÿ"1"'als nicht abgeglichen markieren
ÿÌÿ™sendfile$
ÿïÿ™sendfile$
 ÿ’ÿ¡

 'alles io
 WriteToSend%ÿÿ1
 ÿwWriteToSendEnde 
 
WriteToSendEnde: 
 Superbase.ErrorTrapLabelÿoldErrorLabel$
 ÿ’ÿÿ
 '***********************************************************************************************


ÿÿWriteToLoad%(datei$,doUndirty%)
 

 ' šbernimmt die im PPCS-Modus ge„nderten/hinzugefgten Daten in die *Load - files
 ' ==> a) _datei$ ist eine ber PPCS ge”ffnete Datei
 '     b) dies ist in jedem Fall ein Abgleich zur Filiale hin ... 
 '        Datens„tze sind bereits als abgeglichen markiert,wenn 
 '        Aufruf von WriteTo aus (doUndirty% = 0)
 '    
 '  - Aufruf: von WriteTo() oder CenterToLoadEx() aus (also immer bei GPPCS$ = "TRUE")
 '  - globale Variablen mit File-Information werden vorher ber GetFileInfo() gelesen
 '    (das machen auch WriteTo() bzw. CenterToLoadEx())

'IF jaDebug% = - 1 THEN CALL Fehler("WriteToLoad: " + datei$,"")

oldErrorLabel$ÿSuperbase.ErrorTrapLabel
ÿ³ÿ_ÿwWriteToLoadError
WriteToLoad%ÿ0

LoadFile$ÿjaFilePrefix$ÿ"Load"
LoadIndex$ÿjaFileCode$ÿ"."ÿloadfile$'der Code-Index in *Load.sbf
CenterCode$ÿjaFileCode$ÿ"."ÿdatei$' 'Code-Index in Center-File
RecIndex$ÿjaRecField$ÿ"."ÿdatei$'Index, der in CenterToLoadEx benutzt wird
TStateField$ÿ"TState."ÿloadfile$
ÿ¡doUndirty%ÿÿ1ÿp'Aufruf von CenterToLoadEx() ?

'~~~~~~~~~~~~~~~~~~~~~ Protokoll nur fr CenterToLoadEx
ÿƒAbgleichLog(CenterCode$$,0)
'~~~~~~~~~~~~~~~~~~~~~       
	'den Datensatz im eigenen RecStatus-Feld des Center-Files als abgeglichen markieren
	a$ÿCenterCode$$
	wks$ÿ"Workstation."ÿdatei$
	recfield$ÿjaRecField$ÿ"."ÿdatei$
	ÿÉÿYÿáÿ™datei$ÿ£recfield$$
	recfield$$ÿ10000000ÿwks$$
	ÿÌÿ™datei$
	ÿïÿYÿ™datei$
	ÿÉÿYÿ™datei$ÿ£CenterCode$$'Befehle davor „ndern den Index 

ÿ^

ÿ¡Workstation%ÿ0ÿjaCenterDirty%ÿÿ1ÿp

'kommt bei einer "Speichern"-Aktion beim Onlinebetrieb einer Filiale vor          

'wenn noch nicht gesetzt ==> in ini schreiben und Variable setzen

'bedeutet: LoadToLocal ist sp„testens mit dem n„chsten Programmstart n”tig

ÿƒWriteConfig("PROVIS","LTL","1")

jaCenterDirty%ÿÿ1
ÿ’ÿ¡
 
ÿ’ÿ¡

ÿ¡ÿOÿ´(LoadFile$)ÿp
ÿƒDFile(2,"\ABGLEICH\Load\"ÿLoadFile$ÿ";paris")
ÿ³ÿ_ÿwWriteToLoadError
ÿ’ÿ¡

code$ÿCenterCode$$'die Code des zu kopierenden Datensatzes im Center-file 
ÿ¡ÿOÿJ(code$,LoadIndex$$)ÿp
'Datensatz ex. noch nicht ==> neu erzeugen
ÿÿ™LoadFile$
ÿ¡CopyRecord%(datei$,LoadFile$)ÿÿ1ÿp
ÿwWriteToLoadError
ÿ’ÿ¡
TStateField$$ÿ"1"'als nicht abgeglichen markieren
ÿÌÿ™LoadFile$
ÿïÿYÿ™LoadFile$
ÿ^
'Datensatz ex. ==> gegebenenfalls den ex. Datensatz berschreiben
ÿÉÿ`ÿ™LoadFile$ÿ£LoadIndex$$
ÿÉÿ¥code$ÿáÿ™LoadFile$ÿ£LoadIndex$$
ÿ¡CopyRecord%(datei$,LoadFile$)ÿÿ1ÿp
ÿwWriteToLoadError
ÿ’ÿ¡
TStateField$$ÿ"1"'als nicht abgeglichen markieren
ÿÌÿ™LoadFile$
ÿïÿYÿ™LoadFile$
ÿ’ÿ¡

ÿ¡doUndirty%ÿÿ1ÿp
'~~~~~~~~~~~~~~~~~~~~~ Protokoll nur fr CenterToLoadEx
ÿƒAbgleichLog(",OK",ÿ1)
'~~~~~~~~~~~~~~~~~~~~~     
ÿ’ÿ¡

'alles io
WriteToLoad%ÿÿ1
ÿwWriteToLoadEnde

WriteToLoadError: 
ÿ¡jaDebug%ÿÿ1ÿpÿƒFehler("Fehler in WriteToLoad: "ÿdatei$,ÿ(ÿ&,"z")ÿ": "ÿÿ((ÿ&))
ÿ¡doUndirty%ÿÿ1ÿp
'~~~~~~~~~~~~~~~~~~~~~ Protokoll nur fr CenterToLoadEx
ÿƒAbgleichLog(",ERROR,"ÿÿ(ÿ&,"z")ÿ","ÿÿ((ÿ&),ÿ1)
'~~~~~~~~~~~~~~~~~~~~~      
ÿ’ÿ¡
ÿwWriteToLoadEnde

WriteToLoadEnde: 
Superbase.ErrorTrapLabelÿoldErrorLabel$
 ÿ’ÿÿ
 '***********************************************************************************************     


 'Send-Routine
 '  - ruft fr alle Dateien vom "A" - Typ die Routine SendEx(...) auf
 '
ÿÿSend()
 
oldErrorLabel$ÿSuperbase.ErrorTrapLabel
ÿ³ÿ_ÿwSendError
jaSendSucc%ÿÿ1
ÿ×w ÿUSDIWindow 
ÿÊw ÿSuperbase.Windows(1)
 

'ber alle abzugleichenden Dateien: SendEx(...) aufrufen 
ÿÉÿ`ÿ™"AbgFiles"ÿ£CodeFile.AbgFiles
ÿØÿOÿB("AbgFiles")

ÿ³ÿ_ÿwSendNextError
ÿ¡Typ.AbgFilesÿ"A"ÿp
 
'Send-Variablen  
fileName$ÿFileName.AbgFiles
sendFile$ÿPrefix.AbgFilesÿ"Send"
sendCode$ÿCodeField.AbgFiles
 
w.Form.TitleL.CaptionÿfileName$
w.Form.CounterL.Captionÿ"0"
w.Form.FktL.Captionÿ" "
ÿœ
 
ÿ¡ÿOÿ´(sendFile$)ÿp
ÿƒDFile(2,"Abgleich\Send\"ÿsendFile$ÿ";paris")
ÿ³ÿ_ÿwSendNextError
ÿ’ÿ¡
'Center-File wird in SendEx ge”ffnet (falls n”tig)
ÿƒSendEx(fileName$,sendFile$,sendCode$)
 
ÿ’ÿ¡
'alles io
ÿwSendNext
SendNextError: 
jaSendSucc%ÿ0
'~~~~~~~~~~~~~~~~~~~~~
ÿƒAbgleichLog(" ",ÿ1)
ÿƒAbgleichLog("ERROR,"ÿÿ(ÿ&,"z")ÿ","ÿÿ((ÿ&),ÿ1)
'~~~~~~~~~~~~~~~~~~~~~   
ÿwSendNext 

SendNext: 
ÿ³ÿ_ÿwSendError
ÿÉÿ±ÿ™"AbgFiles"ÿ£CodeFile.AbgFiles
ÿÙ
'alles io
ÿwSendEnde

SendError: 
jaSendSucc%ÿ0
ÿ¡jaDebug%ÿÿ1ÿpÿƒFehler("Fehler in Send: "ÿdatei$,ÿ(ÿ&,"z")ÿ": "ÿÿ((ÿ&))
'~~~~~~~~~~~~~~~~~~~~~
ÿƒAbgleichLog(" ",ÿ1)
ÿƒAbgleichLog("ERROR,"ÿÿ(ÿ&,"z")ÿ","ÿÿ((ÿ&),ÿ1)
'~~~~~~~~~~~~~~~~~~~~~  
ÿwSendEnde

SendEnde: 
 
Superbase.ErrorTrapLabelÿoldErrorLabel$
 ÿ’ÿÿ
 '***********************************************************************************************      
 
 
 'SendEx-Routine
 '  - nimmt den tats„chlichen Datenabgleich F --> Z  vor und leert das Send-File
 '  - Parameter:
 '      * centerFile$: PPCS-Ziel-Datei (Zentrale)
 '      * sendFile$: temp. Abgleichs-Datei (Prefix + "Send")
 '      * guidField$: Feld-Name des GUID

ÿÿSendEx(centerFile$,sendFile$,guidField$)

oldErrorLabel$ÿSuperbase.ErrorTrapLabel
ÿ¡jaDebug%ÿÿ1ÿpÿƒFehler("SendEx()",centerFile$)
ÿ³ÿ_ÿwSendExError 
 
ÿ×w ÿUSDIWindow 
ÿÊw ÿSuperbase.Windows(1)
w.Form.FktL.Captionÿ"Daten senden ..."
ÿœ
'~~~~~~~~~~~~~~~~~~~~~
ÿƒAbgleichLog("",ÿ1)
ÿƒAbgleichLog(sendFile$ÿ"-->"ÿcenterFile$,ÿ1)
'~~~~~~~~~~~~~~~~~~~~~  
sendGUID$ÿguidField$ÿ"."ÿsendFile$
centerGUID$ÿguidField$ÿ"."ÿcenterFile$
sendTState$ÿ"TState."ÿsendFile$
 
'Send-Datei durchlaufen und die zugeh”rigen Datens„tze im Center-File
'erzeugen bzw. neuerstellen  
firstLoop%ÿÿ1
z%ÿ0
recordSuccess%ÿÿ1' wurden alle Datens„tze erfolgreich bearbeitet?
ÿ³ÿ_ÿwSendExError

ÿÉÿ`ÿ™sendFile$ÿ£sendGUID$$
ÿØÿOÿB(sendFile$)

ÿ¡firstLoop%ÿÿ1ÿp
firstLoop%ÿ0
ÿ¡ÿ´(centerFile$)ÿp
'Wenn offen ==> lokal oder ber PPCS ge”ffnet ?
ÿ¡IsOnline%(centerFile$)ÿ0ÿp
' ==> also nicht Online ==> schlieáen und ber PPCS ”ffnen 
ÿ†ÿ™centerFile$
w.Form.FktL."Datenbank ”ffnen ..."
ÿœ
ÿƒDFile(30,centerFile$ÿ";paris")
ÿ¡ÿOÿ´(centerFile$)ÿpÿwSendExError
ÿ³ÿ_ÿwSendExError
ÿ’ÿ¡
ÿ^
w.Form.FktL.Captionÿ"Datenbank ”ffnen ..."
ÿœ
ÿƒDFile(30,centerFile$ÿ";paris")
ÿ¡ÿOÿ´(centerFile$)ÿpÿwSendExError
ÿ³ÿ_ÿwSendExError
ÿ’ÿ¡
w.Form.FktL.Captionÿ"Daten abgleichen ..."
ÿ’ÿ¡

ÿ³ÿ_ÿwSendExAbglError 'Fehler-Erkennung Datensatzweise 
ÿ¡ÿJ(sendGUID$$,centerGUID$$)ÿp
 
'Datensatz existiert schon ==> berschreiben
'~~~~~~~~~~~~~~~~~~~~~
ÿƒAbgleichLog("OVERWRITE,"ÿsendGUID$$,0)
'~~~~~~~~~~~~~~~~~~~~~
 
ÿÉÿ`ÿ™centerFile$ÿ£centerGUID$$
ÿÉÿ¥sendGUID$$ÿ™centerFile$ÿ£centerGUID$$
ÿÉÿYÿáÿ™centerFile$ÿ£centerGUID$$
ÿ¡CopyRecord%(sendFile$,centerFile$)ÿÿ1ÿpÿwSendExAbglError
sendTState$$ÿ""'als abgeglichen markieren

ÿÌÿ™centerFile$
ÿïÿYÿ™centerFile$
ÿ^

'Existiert noch nicht ==> sowieso ins Center-File stopfen
'~~~~~~~~~~~~~~~~~~~~~
ÿƒAbgleichLog("NEW,"ÿsendGUID$$,0)
'~~~~~~~~~~~~~~~~~~~~~

ÿÿ™centerFile$
ÿ¡CopyRecord%(sendFile$,centerFile$)ÿÿ1ÿpÿwSendExAbglError 
sendTState$$ÿ""'als abgeglichen markieren
ÿÌÿ™centerFile$
ÿ’ÿ¡
z%ÿz%ÿ1
'~~~~~~~~~~~~~~~~~~~~~
ÿƒAbgleichLog(",OK",ÿ1)
'~~~~~~~~~~~~~~~~~~~~~ 
'fr diesen Datensatz alles i.o.
ÿwSendExAbglNext
 
SendExAbglError: 
jaSendSucc%ÿ0
recordSuccess%ÿ0
ÿ¡jaDebug%ÿÿ1ÿpÿƒFehler("Fehler in SendEx():"ÿsendFile,ÿ((ÿ&))
'~~~~~~~~~~~~~~~~~~~~~
ÿƒAbgleichLog(",ERROR,"ÿÿ(ÿ&,"z")ÿ","ÿÿ((ÿ&),ÿ1)
'~~~~~~~~~~~~~~~~~~~~~
ÿwSendExAbglNext

SendExAbglNext: 
ÿ³ÿ_ÿwSendExError
w.Form.CounterL.Captionÿÿ(z%,"z")
ÿÉÿ±ÿ™sendFile$ÿ£sendGUID$$
ÿÙ

 
'Send-File (soweit m”glich) leeren
ÿ¡recordSuccess%ÿÿ1ÿp
'alles io ==> Send-File auf die harte (schnelle) Tour leeren
ÿ¾ÿaÿ™sendFile$
ÿ^
'Problem aufgetreten ==> nur die Datens„tze l”schen, die abgeglichen wurden
ÿÉÿ`ÿ™sendFile$ÿ£sendGUID$$
ÿØÿOÿB(sendFile$)
 
ÿ¡sendTState$$ÿ""ÿp
ÿÉÿYÿáÿ™sendFile$ÿ£sendGUID$$
ÿÉÿ¾ÿ™sendFile$
ÿ^
ÿÉÿ±ÿ™sendFile$ÿ£sendGUID$$
ÿ’ÿ¡
 
ÿÙ

ÿ’ÿ¡
'alles io
ÿwSendExEnde

SendExError: 
jaSendSucc%ÿ0
ÿ¡jaDebug%ÿÿ1ÿpÿƒFehler("Fehler in SendEx: "ÿdatei$,ÿ(ÿ&,"z")ÿ": "ÿÿ((ÿ&))
'~~~~~~~~~~~~~~~~~~~~~
ÿƒAbgleichLog(" ",ÿ1)
ÿƒAbgleichLog("ERROR,"ÿÿ(ÿ&,"z")ÿ","ÿÿ((ÿ&),ÿ1)
'~~~~~~~~~~~~~~~~~~~~~ 
ÿwSendExEnde

SendExEnde: 
 
Superbase.ErrorTrapLabelÿoldErrorLabel$
 ÿ’ÿÿ
 '***********************************************************************************************     


ÿÿCenterToLoad()
 'protokolliert Daten, die fr eine Filiale durch zentrale Mitarbeiter ge„ndert wurden
 'diese ge„nderten/neuen Daten werden in die LoadFiles geschrieben und wie Daten behandelt, 
 'die vom Filial-Mitarbeter selbst online ge„ndert wurden
 '==> den Daten in den LoadFiles sieht man nicht an, ob sie von einem zentralen oder filialen-Mitarbeiter
 'erzeugt wurden  
 '
 ' Insgesamt fr alle Dateien (max.) 2 Teil-Abl„ufe
 '      a) CenterToLoadEx (dort erfolgt Verzweigung in Typ "Z" oder Typ "A")
 '      b) LoadToLocal: nur fr Typ "A"
 '
 'Vorgang Bsp. Adressen
 '  - das zust„ndige Rec-Feld auf Dirty-Zustand prfen und gegebenenfalls den 
 '    Datensatz in die AdrLoad kopieren

ÿ¡jaDebug%ÿÿ1ÿpÿƒFehler("CenterToLoad()","")
oldErrorLabel$ÿSuperbase.ErrorTrapLabel
ÿ³ÿ_ÿwCTLError

jaCTLSucc%ÿÿ1
ÿ×w ÿUSDIWindow 
ÿÊw ÿSuperbase.Windows(1)
w.Form.TitleL.Captionÿ" "
w.Form.CounterL.Captionÿ"0"
w.Form.FktL.Captionÿ" "
ÿœ
ÿÉÿ`ÿ™"AbgFiles"ÿ£CodeFile.AbgFiles
ÿØÿOÿB("AbgFiles")

ÿ³ÿ_ÿwCTLNextError 
ÿ¡(Typ.AbgFilesÿ"A")ÿ(Typ.AbgFilesÿ"Z")ÿ(Typ.AbgFilesÿ"C")ÿ(Typ.AbgFilesÿ"Y")ÿp
filename$ÿFileName.AbgFiles
w.Form.TitleL.Captionÿfilename$
w.Form.CounterL.Captionÿ"0"
ÿœ
path$ÿDir.AbgFilesÿ"\"
typ$ÿTyp.AbgFiles
code$ÿCodeField.AbgFiles

ÿ¡CenterToLoadEx%(filename$,path$,typ$,code$)ÿÿ1ÿp
jaCTLSucc%ÿ0
ÿ’ÿ¡

ÿ’ÿ¡'ende wenn Typ = A, Z, C, Y

'alles io
ÿwCTLNext

CTLNextError: 
jaCTLSucc%ÿ0'Fehler registrieren
ÿ¡jaDebug%ÿÿ1ÿpÿƒFehler("Fehler in CenterToLoad: "ÿdatei$,ÿ(ÿ&,"z")ÿ": "ÿÿ((ÿ&))
'~~~~~~~~~~~~~~~~~~~~~
ÿƒAbgleichLog("",ÿ1)'neue Zeile 
ÿƒAbgleichLog("ERROR,"ÿÿ(ÿ&,"z")ÿ","ÿÿ((ÿ&),ÿ1)
'~~~~~~~~~~~~~~~~~~~~~
ÿwCTLNext
CTLNext: 
ÿ³ÿ_ÿwCTLError
ÿÉÿ±ÿ™"AbgFiles"ÿ£CodeFile.AbgFiles
ÿÙ
'alles io
ÿwCTLEnde

CTLError: 
jaCTLSucc%ÿ0
ÿ¡jaDebug%ÿÿ1ÿpÿƒFehler("Fehler in CenterToLoad: "ÿdatei$,ÿ(ÿ&,"z")ÿ": "ÿÿ((ÿ&))
'~~~~~~~~~~~~~~~~~~~~~
ÿƒAbgleichLog("",ÿ1)'neue Zeile 
ÿƒAbgleichLog("ERROR,"ÿÿ(ÿ&,"z")ÿ","ÿÿ((ÿ&),ÿ1)
'~~~~~~~~~~~~~~~~~~~~~
 
ÿwCTLEnde

CTLEnde: 

 Superbase.ErrorTrapLabelÿoldErrorLabel$

 ÿ’ÿÿ
 '*********************************************************************************************** 


ÿÿCenterToLoadEx%(datei$,path$,typ$,code$)
 '- Startet Kopier-Vorgang aller ge„nderten/neuen Datens„tze von einer 
 '  Center- zur passenden Load-Datei 
 '- ...Datensatz-weise 
 '- Aufruf von WriteToLoad%() und CenterToLoad() aus
 '- nur die Datens„tze sichtbarer Workstations werden behandelt
 '- Aufruf mit typ$ = "Z" nur von CenterToLoad() aus 
 '- Aufruf von WriteToLoad%() nur mit typ$ = "A"

ÿ¡jaDebug%ÿÿ1ÿpÿƒFehler("CenterToLoadEx: "ÿdatei$,"")
oldErrorLabel$ÿSuperbase.ErrorTrapLabel
ÿ³ÿ_ÿwCTLExError

CenterToLoadEx%ÿ0
datei$ÿÿ>(datei$)
ÿ×w ÿUSDIWindow
ÿÊw ÿSuperbase.Windows(1)
z%ÿ0

ÿƒGetFileInfo(datei$)'wird von WriteToLoad ben”tigt

'~~~~~~~~~~~~~~~~~~~~~ 
ÿƒAbgleichLog("",ÿ1)
ÿƒAbgleichLog(datei$ÿ"-->"ÿjaFilePrefix$ÿ"Load",ÿ1)
'~~~~~~~~~~~~~~~~~~~~~   

recfield$ÿjaRecField$ÿ"."ÿdatei$

ÿÉÿætyp$
 
ÿæ"Z"
 
ÿ¡ÿ´("temp")ÿpÿ†ÿ™"temp"'sis
dirty$ÿ"rec0."ÿdatei$
 
'Datei lokal ”ffnen
ÿ¡ÿ´(datei$)ÿp
'Wenn offen ==> lokal oder ber PPCS ge”ffnet ?
ÿ¡IsOnline%(datei$)ÿÿ1ÿp
' ==> also Online ==> schlieáen und lokal ”ffnen 
ÿ†ÿ™datei$
ÿƒDFile(2,path$ÿdatei$ÿ";paris")
ÿ¡ÿOÿ´(datei$)ÿpÿwCTLExError
ÿ³ÿ_ÿwCTLExError
ÿ’ÿ¡
ÿ^
ÿƒDFile(2,path$ÿdatei$ÿ";paris")
ÿ¡ÿOÿ´(datei$)ÿpÿwCTLExError
ÿ’ÿ¡
	
'lokale Datei komplett als Memory-File kopieren und schlieáen
w.Form.FktL.Captionÿ"Vorbereiten der Datenbernahme ..."
ÿœ
ÿ‰ÿ™ÿ«"temp"ÿaÿ™datei$
ÿ†ÿ™datei$

'die Zentrale Datei wieder ”ffnen
w.Form.FktL.Captionÿ"Datenbank ”ffnen ..."
ÿœ
ÿƒDFile(20,datei$ÿ";paris")
ÿ¡ÿOÿ´(datei$)ÿpÿwCTLExError
ÿ³ÿ_ÿwCTLExError

w.Form.FktL.Captionÿ"Daten bernehmen ..."
ÿœ

tempcode$ÿcode$ÿ".temp"
code$ÿcode$ÿ"."ÿdatei$
wks$ÿ"Workstation."ÿdatei$
tempdirty$ÿ"rec0.temp"

'ber alle zentralen Datens„tze
ÿÉÿ`ÿ™datei$ÿ£code$$
ÿØÿOÿB(datei$)
ÿ³ÿ_ÿwCTLExNextErr1
a$ÿcode$$
copyrecord%ÿÿ1'initial: der Datensatz existiert noch nicht
ÿ¡ÿJ(code$$,tempcode$$)ÿp

ÿÉÿ¥code$$ÿ™"temp"ÿ£tempcode$$
'Datensatz existiert doch schon ==> unver„ndert seit letztem Abgleich?
ÿ¡tempdirty$$ÿdirty$$ÿp
copyrecord%ÿ0
ÿ’ÿ¡
ÿ’ÿ¡
 
ÿ¡copyrecord%ÿÿ1ÿp


ÿ¡WriteToLoad%(datei$,ÿ1)ÿÿ1ÿp' "-1": Un-Dirty in WriteToLoad() vornehmen                       
ÿwCTLExNextErr1 
ÿ’ÿ¡

z%ÿz%ÿ1
w.Form.CounterL.Captionÿÿ(z%,"z")ÿ" "
ÿœ
ÿ’ÿ¡
'alles io
ÿwCTLExNext1
CTLExNextErr1: 
ÿ¡jaDebug%ÿÿ1ÿpÿƒFehler("Fehler in CenterToLoadEx: "ÿdatei$,ÿ(ÿ&,"z")ÿ": "ÿÿ((ÿ&))
'Error-Log wird von WriteToLoad geschrieben
jaCTLSucc%ÿ0
ÿwCTLExNext1 
CTLExNext1: 
ÿ³ÿ_ÿwCTLExError
ÿÉÿ±ÿ™datei$ÿ£code$$
ÿÙ

ÿ†ÿ™"temp"

ÿæ"C","A","Y"

code$ÿcode$ÿ"."ÿdatei$
ÿ¡ÿ´(datei$)ÿp
'Wenn offen ==> lokal oder ber PPCS ge”ffnet ?
ÿ¡IsOnline%(datei$)ÿ0ÿp
' ==> also nicht Online ==> schlieáen und ber PPCS ”ffnen 
ÿ†ÿ™datei$
w.Form.FktL.Captionÿ"Datenbank ”ffnen ..."
ÿœ
ÿƒDFile(20,path$ÿdatei$ÿ";paris")
ÿ¡ÿOÿ´(datei$)ÿpÿwCTLExError
ÿ³ÿ_ÿwCTLExError
ÿ’ÿ¡
ÿ^
w.Form.FktL.Captionÿ"Datenbank ”ffnen ..."
ÿœ
ÿƒDFile(20,path$ÿdatei$ÿ";paris")
ÿ¡ÿOÿ´(datei$)ÿpÿwCTLExError
ÿ³ÿ_ÿwCTLExError
ÿ’ÿ¡

ifrom%ÿ0' von Wks
ito%ÿVisCount%ÿ1' bis Wks ... also erstmal fr alle sichbaren Filialen

ÿ¡typ$ÿ"A"ÿjaLoadSubOff%ÿ0ÿp
'nur die eigenen Daten laden ==> welchen Index hat das aktuelle Bro?
ifrom%ÿGetVisWksIndex%(Workstation%)
ito%ÿifrom%
ÿ¡ifrom%ÿÿ1ÿp
ito%ÿÿ2
ÿ¡jaDebug%ÿÿ1ÿpÿƒFehler("Wks-Index nicht gefunden:","Workstation = "ÿÿ(Workstation%,"z))
ÿ’ÿ¡
ÿ’ÿ¡


'array mit GUID's holen, die abgeglichen werden mssen
ÿ×guid$(0)
guidCount%ÿ0
ÿ›i%ÿifrom%ÿqito%
wks%ÿVisOff%(i%)'sichbares Bro = Žnderungs-STATUS dieses Bros                
w.Form.TitleL.Captionÿw.Form.TitleL.Captionÿ" ("ÿVisNames$(i%)ÿ")"
ÿœ
'hat Bro wks% oder Zentrale in den Daten von wks% etwas ge„ndert?
ÿ³ÿ_ÿwCTLExError
ÿÉÿ`ÿ™datei$ÿ£recfield$$
ÿÉÿ¥wks%ÿ™datei$ÿ£recfield$$
ÿØÿOÿB(datei$)ÿrecfield$$ÿwks%
*
guidCount%ÿguidCount%ÿ1
ÿÿguid$(guidCount%)
guid$(guidCount%ÿ1)ÿcode$$
 
ÿÉÿ±ÿ™datei$ÿ£recfield$$'den Miálungenen berspringen                     
ÿÙ
 
ÿ±i%'n„chstes sichtbares Bro  

guidNo%ÿ0
ÿ›guidNo%ÿ0ÿqguidCount%

ÿÉÿ`ÿ™datei$ÿ£code$$
ÿÉÿ¥guid$(guidNo%)ÿ™datei$ÿ£code$$
ÿ¡ÿC(datei$)ÿp

ÿ¡WriteToLoad%(datei$,ÿ1)ÿÿ1ÿp' "-1": Un-Dirty in WriteToLoad() vornehmen
ÿwCTLExNextErr2
ÿ’ÿ¡
 
ÿ^
ÿwCTLExNextErr2 
ÿ’ÿ¡

z%ÿz%ÿ1
w.Form.CounterL.Captionÿÿ(z%,"z")ÿ" "
ÿœ
'alles io
ÿwCTLExNext2

CTLExNextErr2: 
ÿ¡jaDebug%ÿÿ1ÿpÿƒFehler("Fehler in CenterToLoadEx: "ÿdatei$,ÿ(ÿ&,"z")ÿ": "ÿÿ((ÿ&))
'Error-Log wird von WriteToLoad geschrieben
jaCTLSucc%ÿ0
ÿwCTLExNext2
 
CTLExNext2:

ÿ³ÿ_ÿwCTLExError 

ÿ±guidNo%
 
ÿ’ÿÉ

'alles io
CenterToLoadEx%ÿÿ1
ÿwCTLExEnde

CTLExError: 
ÿ¡jaDebug%ÿÿ1ÿpÿƒFehler("Fehler in CenterToLoadEx: "ÿdatei$,ÿ(ÿ&,"z")ÿ": "ÿÿ((ÿ&))
ÿƒAbgleichLog("",ÿ1)'neue Zeile 
ÿƒAbgleichLog("ERROR,"ÿÿ(ÿ&,"z")ÿ","ÿÿ((ÿ&),ÿ1)
jaCTLSucc%ÿ0
ÿwCTLExEnde

CTLExEnde:
Superbase.ErrorTrapLabelÿoldErrorLabel$

 ÿ’ÿÿ
 '***********************************************************************************************   
 

ÿÿLoadToLocal()
 'ruft LoadToLocalEx(..) fr alle abzugleichenden Dateien auf     
ÿ¡jaDebug%ÿÿ1ÿpÿƒFehler("LoadToLocal()","")
oldErrorLabel$ÿSuperbase.ErrorTrapLabel
ÿ³ÿ_ÿwErrorHandler
 
jaLTLSucc%ÿÿ1
ÿ×w ÿUSDIWindow 
ÿÊw ÿSuperbase.Windows(1)
w.Form.FktL.Captionÿ"Zentrale Daten speichern ..."
ÿœ
 
ÿÉÿ`ÿ™"AbgFiles"ÿ£CodeFile.AbgFiles

ÿØÿOÿB("AbgFiles")

ÿ¡(Typ.AbgFilesÿ"A")ÿ(Typ.AbgFilesÿ"C")ÿ(Typ.AbgFilesÿ"Z")ÿp
localfile$ÿFileName.AbgFiles
loadfile$ÿPrefix.AbgFilesÿ"Load"
ind$ÿCodeField.AbgFiles
path$ÿDir.AbgFilesÿ"\"
w.Form.TitleL.Captionÿlocalfile$
w.Form.CounterL.Captionÿ"0"
ÿœ
ÿ¡LoadToLocalEx%(loadfile$,localfile$,ind$,path$)ÿÿ1ÿpi%ÿ1
ÿ’ÿ¡

ÿÉÿ±ÿ™"AbgFiles"ÿ£CodeFile.AbgFiles
ÿÙ
 ÿ’ÿÿ
 '***********************************************************************************************    
 

ÿÿLoadToLocalEx%(LoadFile$,LocalFile$,ind$,path$)
 'Laden der Daten, die durch Bro-User online hinzugefgt/ver„ndert wurden 
 'bzw. der Daten, die durch einen zentralen Mitarbeiter in die Zentrale eingefgt und durch
 'einen Aufruf von LoadCenterEx() durch den filialen Mitarbeiter in die LoadFiles kopiert wurden
 '==> Load-files enthalten ausschlieálich zentrale ID's
 '==> beim Load nur prfen, ob die Load-files Daten enthalten und wenn, 
 '    dann nur an der Frage orientieren, ob die ID's dieser Datens„tze bereits 
 '    in den lokalen files vorhanden sind - „hnlich wie in WriteToLoad
 '
 '   Aufruf durch LoadFiles%() 

 '   - glcLocal1$ und glcLocal2$ zweckentfremden, um erfolgten Abgleich zu markieren
oldErrorLabel$ÿSuperbase.ErrorTrapLabel
ÿ³ÿ_ÿwLTLExError
ÿ¡jaDebug%ÿÿ1ÿpÿƒFehler("LoadToLocalEx: "ÿLoadFile$ÿ" --> "ÿLocalFile$,"")

LoadToLocalEx%ÿ0
ÿ×w ÿUSDIWindow 
ÿÊw ÿSuperbase.Windows(1)

'~~~~~~~~~~~~~~~~~~~~~ 
ÿƒAbgleichLog("",ÿ1)
ÿƒAbgleichLog(LoadFile$ÿ"-->"ÿLocalFile$,ÿ1)
'~~~~~~~~~~~~~~~~~~~~~  

ÿ¡ÿOÿ´(LoadFile$)ÿp
ÿƒDFile(2,"ABGLEICH\Load\"ÿLoadFile$ÿ";paris")
ÿ¡ÿOÿ´(LoadFile$)ÿpÿwLTLExError
ÿ³ÿ_ÿwLTLExError
ÿ’ÿ¡

ÿ¡ÿ´(LocalFile$)ÿp
ÿ¡IsOnline%(LocalFile$)ÿÿ1ÿp
ÿ†ÿ™LocalFile$'die zentrale Tabelle schieáen..
ÿƒDFile(2,path$ÿLocalFile$ÿ";paris")
ÿ¡ÿOÿ´(LocalFile$)ÿpÿwLTLExError 
ÿ’ÿ¡
ÿ^
ÿƒDFile(2,path$ÿLocalFile$ÿ";paris")
ÿ¡ÿOÿ´(LocalFile$)ÿpÿwLTLExError 
ÿ’ÿ¡
ÿ³ÿ_ÿwLTLExError

LoadIndex$ÿind$ÿ"."ÿLoadFile$'der Code-Index in *Load.sbf
LocalIndex$ÿind$ÿ"."ÿLocalFile$'der Code-Index der lokalen sbf - z.B. "CodeKu.Adressen"
LoadTState$ÿ"TState."ÿLoadFile$'TState der LoadFiles - z.B. "TState.AdrLoad"
 
z%ÿ0
recordSuccess%ÿÿ1
w.Form.FktL.Captionÿ"Daten bernehmen ..."
ÿœ
ÿÉÿ`ÿ™LoadFile$ÿ£LoadIndex$$
ÿØÿOÿB(LoadFile$)
ÿ³ÿ_ÿwLTLExError2

code$ÿLoadIndex$$'die Code des zu kopierenden Datensatzes im Load-file 
ÿ¡ÿOÿJ(code$,LocalIndex$$)ÿp
'Datensatz ex. noch nicht ==> neu erzeugen
ÿÿ™LocalFile$
ÿ¡CopyRecord%(LoadFile$,LocalFile$)ÿÿ1ÿpÿwLTLExError2 
LoadTState$$ÿ""'als abgeglichen markieren
ÿÌÿ™LocalFile$
'~~~~~~~~~~~~~~~~~~~~~
ÿƒAbgleichLog("",ÿ1)
ÿƒAbgleichLog("NEW,"ÿcode$,0)
'~~~~~~~~~~~~~~~~~~~~~    
	ÿ^
'Datensatz ex. ==> Daten berschreiben
ÿÉÿ`ÿ™LocalFile$ÿ£LocalIndex$$
ÿÉÿ¥code$ÿáÿ™LocalFile$ÿ£LocalIndex$$
ÿ¡CopyRecord%(LoadFile$,LocalFile$)ÿÿ1ÿpÿwLTLExError2
LoadTState$$ÿ""'als abgeglichen markieren
ÿÌÿ™LocalFile$
ÿïÿYÿ™LocalFile$
'~~~~~~~~~~~~~~~~~~~~~
ÿƒAbgleichLog("",ÿ1)
ÿƒAbgleichLog("OVERWRITE,"ÿcode$,0)
'~~~~~~~~~~~~~~~~~~~~~     
ÿ’ÿ¡
'alles io
'~~~~~~~~~~~~~~~~~~~~~
ÿƒAbgleichLog(",OK",ÿ1)
'~~~~~~~~~~~~~~~~~~~~~        
ÿwLTLExNext

LTLExError2: 
ÿ¡jaDebug%ÿÿ1ÿpÿƒFehler("Fehler in LoadToLocalEx",ÿ(ÿ&,"z")ÿ": "ÿÿ((ÿ&))
recordSuccess%ÿ0
jaLTLSucc%ÿ0
'~~~~~~~~~~~~~~~~~~~~~
ÿƒAbgleichLog(",ERROR,"ÿÿ(ÿ&,"z")ÿ","ÿÿ((ÿ&),ÿ1)
'~~~~~~~~~~~~~~~~~~~~~          
ÿwLTLExNext

LTLExNext: 
z%ÿz%ÿ1
w.Form.CounterL.Captionÿÿ(z%,"z")ÿ" "
ÿœ
ÿ³ÿ_ÿwLTLExError 
ÿÉÿ±ÿ™LoadFile$ÿ£LoadIndex$$
ÿÙ


'Load-File (soweit m”glich) leeren    
ÿ¡recordSuccess%ÿÿ1ÿp
'alles io ==> Send-File auf die harte (schnelle) Tour leeren
ÿ¾ÿaÿ™LoadFile$
ÿ^
'Problem aufgetreten ==> nur die Datens„tze l”schen, die abgeglichen wurden
ÿÉÿ`ÿ™LoadFile$ÿ£LoadIndex$$
ÿØÿOÿB(LoadFile$)
 
ÿ¡LoadTState$$ÿ""ÿp
ÿÉÿYÿáÿ™LoadFile$ÿ£LoadIndex$$
ÿÉÿ¾ÿ™LoadFile$
ÿ^
ÿÉÿ±ÿ™LoadFile$ÿ£LoadIndex$$
ÿ’ÿ¡
 
ÿÙ
ÿ’ÿ¡
 
'alles io
LoadToLocalEx%ÿÿ1
ÿwLTLExEnde

LTLExError: 
jaLTLSucc%ÿ0
ÿ¡jaDebug%ÿÿ1ÿpÿƒFehler("Fehler beim L”schen der Load-Datens„tze: "ÿLoadFile$,ÿ(ÿ&,"z")ÿ": "ÿÿ((ÿ&))
'~~~~~~~~~~~~~~~~~~~~~
ÿƒAbgleichLog(" ",ÿ1)
ÿƒAbgleichLog("ERROR,"ÿÿ(ÿ&,"z")ÿ","ÿÿ((ÿ&),ÿ1)
'~~~~~~~~~~~~~~~~~~~~~  
ÿwLTLExEnde

LTLExEnde: 
 
Superbase.ErrorTrapLabelÿoldErrorLabel$
 ÿ’ÿÿ
 '***********************************************************************************************     


ÿÿCAbgleichLog(extension$)
 'Erzeugt ein Logfile mit einer bestimmten Erweiterung, die durch den Typ der Funktion bestimmt ist, 
 
logfile$ÿÿ7(Superbase.Today,"yymmdd")
i%ÿ1
ÿØÿJ(_remotepath$ÿ"Abgleich\Log\"ÿlogfile$ÿÿ(i%,"00")ÿ"."ÿextension$)
i%ÿi%ÿ1
ÿÙ
logfile$ÿ_remotepath$ÿ"Abgleich\Log\"ÿlogfile$ÿÿ(i%,"00")ÿ"."ÿextension$
ÿ´logfile$ÿ›ÿ¶
ÿ†ÿ¶
jaLogFile$ÿlogfile$
 ÿ’ÿÿ
 '***********************************************************************************************     
 

ÿÿAbgleichLog(logtext$,crlf%)

oldErrorLabel$ÿSuperbase.ErrorTrapLabel
ÿ³ÿ_ÿwLogError
'ex. dasLogfile ? 
ÿ¡ÿOÿJ(jaLogFile$)ÿp
ÿ¡jaDebug%ÿÿ1ÿp
ÿƒFehler ("Log-File existiert nicht: "ÿjaLogFile$,ÿ(ÿ&,"z")ÿ": "ÿÿ((ÿ&))
ÿ’ÿ¡
ÿwLogEnde 
ÿ’ÿ¡
ÿ´jaLogFile$ÿ›ÿT
ÿ¡crlf%ÿÿ1ÿp
ÿ{logtext$
ÿ^
ÿ{logtext$;
ÿ’ÿ¡
ÿ†ÿ¶
'alles io
ÿwLogEnde

LogError:
ÿ¡jaDebug%ÿÿ1ÿpÿƒFehler("Fehler beim Schreiben des Logfiles: "ÿjaLogFile,ÿ(ÿ&,"z")ÿ": "ÿÿ((ÿ&))
ÿwLogEnde

LogEnde: 
Superbase.ErrorTrapLabelÿoldErrorLabel$
 ÿ’ÿÿ

